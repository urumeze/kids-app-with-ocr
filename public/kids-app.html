<!DOCTYPE html>
<html lang="en">
<head>
  
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-2721836557124559">
    <link rel="canonical" href="https://goquiz.app/" />
    <meta name="description" content="GoQuiz Academy: Fun quizzes, past questions, teacher connections, and used books for kids learning.">
    <meta name="robots" content="index, follow">
    <title>GoQuiz Academy</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <!-- Google Fonts: Inter + Material Icons + Comic Neue -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <!-- Feather Icons -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

    <!-- PDF.js & Mammoth (for document processing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.0/mammoth.browser.min.js"></script>

    <!-- Firebase SDK v8 (compat mode) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>

    <!-- Paystack Inline v2 -->
    <script src="https://js.paystack.co/v2/inline.js"></script>

    <!-- JWT Decode (only one needed) -->
    <script src="https://unpkg.com/jwt-decode/build/jwt-decode.min.js"></script>

    <!-- Google Sign-In (One Tap & Identity Services) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Flatpickr (Date/Time Picker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Google AdSense Core Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2721836557124559"
     crossorigin="anonymous"></script>
    
   
      

    <!-- Your Custom Styles -->
    <style>



        :root {
            --bg: #f6fbff;
            --primary: #5c7cfa;
            --accent: #ff66b3;
            --muted: #6b7280;
            --glass: rgba(255, 255, 255, 0.7);
        }

        * { box-sizing: border-box; }
        body, html { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, 'Helvetica Neue', Arial; }

        /* App Shell */
        .app {
            min-height: 100vh;
            background: linear-gradient(180deg, #f8feff 0%, #eef6ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 32px;
        }

        /* Design Class (Comic Neue + Background) */
        .design body {
            font-family: 'Comic Neue', 'Comic Sans MS', 'Chalkboard SE', 'Comic Sans', cursive;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Hide ads when user is ad-free */
        body.is-ad-free .adsbygoogle {
            display: none !important;
        }

        /* Rest of your styles (shapes, animations, header, splash, etc.) */
        .shape { position: absolute; opacity: 0.3; z-index: -1; }
        .circle { border-radius: 50%; background: #FF9AA2; }
        .triangle { width: 0; height: 0; border-left: 50px solid transparent; border-right: 50px solid transparent; border-bottom: 100px solid #FFB7B2; }
        .square { background: #B5EAD7; }
        .pentagon { width: 54px; height: 50px; background: #C7CEEA; position: relative; }
        .pentagon:before { content: ""; position: absolute; top: -25px; left: 0; width: 0; height: 0; border-left: 27px solid transparent; border-right: 27px solid transparent; border-bottom: 25px solid #C7CEEA; }
        .pentagon:after { content: ""; position: absolute; bottom: -25px; left: 0; width: 0; height: 0; border-left: 27px solid transparent; border-right: 27px solid transparent; border-top: 25px solid #C7CEEA; }

        /* Upload, Progress, Animations, etc. */
        .upload-container { border: 3px dashed #94a3b8; transition: all 0.3s; }
        .upload-container:hover { border-color: #6366f1; background-color: rgba(99, 102, 241, 0.05); }
        .bounce { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .rotate { animation: rotate 10s linear infinite; }
        @keyframes rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* Quiz & UI Styles */
        .summary-box { background-color: rgba(255, 255, 255, 0.8); border-radius: 20px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .quiz-option { transition: all 0.3s; }
        .quiz-option:hover { transform: scale(1.05); }
        .correct { background-color: #4ade80 !important; }
        .incorrect { background-color: #f87171 !important; }

        /* Header & Coin Styles */
        #goquizHeader { transform: scale(0.70); transform-origin: top center; }
        .coin-svg { display: inline-block; vertical-align: middle; }
        .coin-svg .shimmerRect { transition: opacity 150ms linear; }
        .coin-svg.flash { transform-origin: center; animation: coinPop 300ms ease; }
        .coin-svg.flash .shimmerRect { opacity: 1; animation: shimmerMove 700ms linear; }
        @keyframes shimmerMove { 0% { transform: translateX(-120px); } 100% { transform: translateX(120px); } }
        @keyframes coinPop { 0% { transform: scale(1); } 50% { transform: scale(1.18); } 100% { transform: scale(1); } }

        /* Splash Screen */
        #splash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #800080; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
            animation: fadeOut 3.5s forwards;
        }
        #splash h1 { color: white; font-size: 3rem; margin-bottom: 30px; font-family: sans-serif; }
        .loader-bar { width: 300px; height: 8px; background-color: #a64ca6; border-radius: 4px; overflow: hidden; }
        .loader-fill { height: 100%; width: 0%; background-color: #1e90ff; border-radius: 4px; animation: fillBar 3s forwards; }
        @keyframes fillBar { from { width: 0%; } to { width: 100%; } }
        @keyframes fadeOut { 0% { opacity: 1; } 85% { opacity: 1; } 100% { opacity: 0; display: none; } }
        #main-content { display: none; }

        /* Music Menu & Other UI */
        .music-menu-container { position: fixed; bottom: 1.5rem; right: 1.5rem; width: 60px; height: 60px; z-index: 50; }
        .menu-toggle-button { background-color: #7e22ce; color: white; border: none; border-radius: 50%; width: 100%; height: 100%; font-size: 26px; cursor: pointer; box-shadow: 0 4px 10px rgba(126, 34, 206, 0.4); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .menu-toggle-button:hover { transform: scale(1.1); box-shadow: 0 6px 14px rgba(126, 34, 206, 0.6); }
        .circular-menu { position: absolute; bottom: 100px; right: 1px; transform: scale(0); border-radius: 10px; width: 30px; height: 220px; display: flex; justify-content: center; align-items: center; opacity: 0; transition: all 0.35s ease-in-out; flex-wrap: wrap; gap: 12px; box-shadow: 0 8px 16px rgba(126, 34, 206, 0.3); }
        .circular-menu.open { transform: scale(1); opacity: 1; }
        .menu-button { background-color: #a855f7; color: white; border: none; border-radius: 50%; width: 55px; height: 55px; font-size: 20px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s, transform 0.2s; }
        .menu-button:hover { background-color: #9333ea; transform: scale(1.1); }

        .hidden { display: none; }
    </style>
</head>


<body class="design">
  
<!-- Splash Screen -->
<div id="splash">
    <h1>GoQuiz.app</h1>
    <div class="loader-bar">
      <div class="loader-fill" id="loader"></div>
    </div>
</div>


<div class="container mx-auto px-4 py-8">

  <div class="container mx-auto px-4 py-8 pt-20">
    <!-- Fixed Header -->
    <header id="goquizHeader"
        class="fixed top-0 left-0 right-0 z-50 bg-indigo-100 shadow-md 
               flex justify-between items-center py-3 px-4 scale-100">

    <!-- Title -->
    <h1 id="goquizTitle"
        class="text-xl font-bold text-white bg-indigo-600 px-4 py-1 rounded-lg">
      GoQuiz
    </h1>

    
<div class="p-4 border-t border-gray-200">
  <button id="removeAdsBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition">
    üåü Remove ads
  </button>
  <p id="adFreeStatus" class="text-center text-sm text-green-600 mt-2 hidden  ">
    ‚úÖ Ad-free!
  </p>
</div>

    

    <!-- Right Side: Points + Convert + GQ Coin -->
    <div id="floatingCoin" class="flex items-center gap-3">

      <!-- Points section -->
      <div class="flex items-center gap-1">
        <div class="bg-gray-100 coin-number text-base font-bold px-2 py-0.5 rounded" id="coinNumber">0</div>
        <div id="pointsLabel" class="font-semibold text-sm text-gray-700">pts</div>
      </div>

      <!-- REQUIRED WRAPPER FOR JS -->
      <!--div id="coinControls"-->

        <!-- Convert Button -->
        <!--button 
          class="flex items-center px-2 py-1 bg-green-500 text-white rounded-md 
                 hover:bg-green-600 transition duration-300 ease-in-out group text-sm shadow">
            <span class="mr-1">Convert</span>
            <span class="text-xl transition-transform duration-500 ease-in-out 
                         group-hover:[transform:rotate(180deg)]">
              ‚Üí
            </span>
        </button>

      </div-->

      <!--span class="font-bold text-lg" id="walletCoinNumber">0</span-->

      <!-- GQ Count + Coin -->
      <div class="flex items-center gap-1">

        <div 
          id="walletCoinNumber" 
          class="text-2xl font-black px-1 py-0.5 bg-white rounded-lg shadow text-center 
                 min-w-[40px] bg-clip-text text-transparent 
                 bg-gradient-to-r from-yellow-400 to-amber-600
                 transition-transform duration-200 ease-out">
          0
        </div>

        <!-- SVG Coin -->
        <svg class="coin-svg" id="gqCoin" xmlns="http://www.w3.org/2000/svg" 
             viewBox="0 0 120 120" width="32" height="32">

          <defs>
            <radialGradient id="gq_g" cx="40%" cy="35%" r="70%">
              <stop offset="0%" stop-color="#fff9c4"/>
              <stop offset="40%" stop-color="#fbc02d"/>
              <stop offset="80%" stop-color="#f57f17"/>
              <stop offset="100%" stop-color="#bf360c"/>
            </radialGradient>

            <linearGradient id="gq_shine" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%" stop-color="rgba(255,255,255,0)" />
              <stop offset="45%" stop-color="rgba(255,255,255,0.9)" />
              <stop offset="55%" stop-color="rgba(255,255,255,0.9)" />
              <stop offset="100%" stop-color="rgba(255,255,255,0)" />
            </linearGradient>
          </defs>

          <circle cx="60" cy="60" r="55" fill="url(#gq_g)" stroke="#b8860b" stroke-width="4"/>
          <circle cx="60" cy="60" r="44" fill="none" stroke="#ffecb3" stroke-width="3"/>
          <circle cx="60" cy="60" r="36" fill="url(#gq_g)" opacity="0.98"/>

          <g class="shimmerGroup">
            <rect x="-120" y="0" width="240" height="120" fill="url(#gq_shine)" 
                  opacity="0" class="shimmerRect"/>
          </g>

          <text x="60" y="74" text-anchor="middle"
                font-family="Inter, Arial, Helvetica, sans-serif"
                font-weight="800" font-size="36" fill="#3b2a0c" 
                stroke="#fff6d8" stroke-width="0.6" paint-order="stroke">
            GQ
          </text>

          <ellipse cx="44" cy="42" rx="28" ry="10" transform="rotate(-20 44 42)"
                   fill="rgba(255,255,255,0.18)" opacity="0.85"/>
        </svg>

      </div>

    </div>
</header>
</div>
</div>











<!-- Teacher Form Overlay -->
<div id="teacherFormOverlay" class="fixed inset-0 bg-black bg-opacity-60 hidden flex justify-center items-center p-4 z-50 scale-[0.7]">
  <div class="bg-white rounded-2xl p-6 w-full max-w-sm space-y-3">
      <h2 class="text-xl font-semibold text-center mb-2">Teacher Profile</h2>

      <input type="text" id="teacherName" placeholder="Full Name" class="w-full border p-2 rounded-xl"/>

      <select id="teacherGender" class="w-full border p-2 rounded-xl">
          <option value="">Select gender</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
      </select>

      <input type="text" id="teacherSubject" placeholder="Subject (e.g. Maths, English)" class="w-full border p-2 rounded-xl"/>
      <input type="tel" id="teacherPhoneNumber" placeholder="Phone number or Whatsapp number " class="w-full border p-2 rounded-xl"/>
      <input type="file" id="teacherImage" accept="image/*" class="w-full"/>

      <button id="submitTeacherPost" class="bg-green-600 text-white w-full py-2 rounded-xl shadow font-bold">
        Submit Profile
      </button>

      <button id="closeTeacherPost" class="text-gray-600 w-full py-2 underline">
        Cancel
      </button>
  </div>
</div>

 
<div class="music-menu-container fixed right-6 z-50 bottom-[25vh] scale-[0.7]">
  <button id="menu-toggle" class="menu-toggle-button">üéµ</button>
  
  <div id="circular-menu" class="circular-menu">
    <button id="next-button" class="menu-button">‚è≠</button>
    <button id="pause-button" class="menu-button">‚è∏</button>
    <button id="prev-button" class="menu-button">‚èÆ</button>
    <button id="play-button" class="menu-button">‚ñ∂</button>
    
  </div>
</div>

<audio id="audio-player"></audio>

<button onclick="openCreateRequest()"
        class="
          scale-[0.7]
          fixed right-6 z-50 bottom-[15vh]
          bg-green-600 hover:bg-green-700 
          text-white font-extrabold text-sm 
          py-3 px-6 rounded-full 
          shadow-lg hover:shadow-xl 
          transform hover:-translate-y-0.5 
          transition duration-300 ease-in-out
          focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50
        ">
  Ask for a Book
</button>

<div id="requestFormOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl w-[90%] max-w-md">
    <h2 class="text-xl font-bold mb-4">Request a Teacher</h2>

    

    <label class="font-semibold">Subject</label>
    <select id="reqSubject" class="w-full p-2 border rounded mb-3">
      <option value="">Any</option>
      <option value="Maths">Maths</option>
      <option value="English">English</option>
      <option value="Biology">Biology</option>
      <option value="Physics">Physics</option>
      <option value="Chemistry">Chemistry</option>
      <option value="Igbo">Igbo</option>
      <option value="French">French</option>
      <option value="Yoruba">Yoruba</option>
      <option value="Hausa">Hausa</option>
    </select>

    <label class="font-semibold">Topic</label>
    <input id="reqTopic" class="w-full p-2 border rounded mb-3">

    <label class="font-semibold">Preferred Gender</label>
    <select id="reqGender" class="w-full p-2 border rounded mb-3">
      <option value="">Any</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select>

    <label class="block mt-3 text-sm font-semibold">
  Preferred Date & Time
</label>

<input
  type="text"
  id="reqDateTime"
  placeholder="Select date & time"
  class="w-full p-2 border rounded"
  readonly
/>


    <label class="font-semibold">Attach Image (Optional)</label>
    <input id="reqImage" type="file" accept="image/*" class="w-full mb-4">

    <div class="flex justify-between mt-4">
      <button onclick="closeCreateRequest()" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
      <button id="submitRequest" class="px-6 py-2 bg-green-600 text-white rounded">Submit</button>
    </div>
  </div>
</div>

<!-- Notification/Payment Modal -->
<div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[60] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl relative">
        <!-- Close button (X) top right -->
        <button onclick="closePaymentModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 material-icons">close</button>
        
        <h3 class="text-center font-bold text-lg mb-2 text-green-700">Connect to User</h3>
        <p class="mb-4 text-center text-sm text-gray-700">
             Contact details (Email & Phone) will be sent to you via mail 
        </p>
        <p class="text-center text-[10px] text-gray-500">
            Notification costs ‚Ç¶100 naira
        </p>

        <!-- ADDED: Phone number input field -->
        <div class="mb-4">
            <label class="block text-xs font-semibold text-gray-500 mb-1 ">INPUT YOUR PHONE NUMBER</label>
            <input type="tel" id="accepterPhone" placeholder="e.g. 08012345678" 
                   class="w-full border border-gray-300 rounded-lg p-3 text-center focus:ring-2 focus:ring-green-500 outline-none" required>
        </div>

        <p class="mb-4 text-center text-[10px] text-gray-500 italic">
             Click OK to proceed to secure payment
        </p>

        <!-- OKAY button -->
        <button onclick="proceedToPayment()" 
                class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
            OK 
        </button>

        <!-- Hidden inputs to store data temporarily -->
        <input type="hidden" id="paymentActionId">
        <input type="hidden" id="paymentActionType">
    </div>
</div>














<!-- Conversion Modal -->
<div id="convertModal" 
     style="display:none; position: fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.6); backdrop-filter:blur(2px); 
            z-index:2000; justify-content:center; align-items:center;">
    
  <div style="background:white; padding:20px; border-radius:12px; width:320px; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
    
    <h2 style="font-size:20px; font-weight:700; margin-bottom:15px;">Convert</h2>

    <!-- FROM dropdown -->
    <label>From:</label>
    <select id="convertFrom" class="w-full p-2 border rounded mb-3">
      <option value="points">Points</option>
      <option value="gq">GQ</option>
    </select>

    <!-- TO dropdown -->
    <label>To:</label>
    <select id="convertTo" class="w-full p-2 border rounded mb-3">
      <option value="gq">GQ</option>
      <option value="points">Points</option>
    </select>

    <!-- Amount -->
    <label>Amount to Convert:</label>
    <input id="convertAmount" 
           type="number" 
           class="w-full p-2 border rounded mb-4" 
           placeholder="Enter amount">

    <!-- Action buttons -->
    <div style="display:flex; justify-content:space-between; margin-top:10px;">
      <button id="closeConvertModal" 
              style="padding:8px 14px; background:#aaa; color:white; border-radius:8px;">Cancel</button>

      <button id="confirmConvert" 
              style="padding:8px 14px; background:#22c55e; color:white; border-radius:8px;">Convert</button>
    </div>

  </div>

</div>


<div id="booksHubModal"
     class="fixed inset-0 bg-black bg-opacity-40 hidden z-50 flex items-center justify-center">

  <div class="bg-white rounded-xl w-11/12 max-w-sm p-5">

    <h3 class="text-center font-bold text-lg mb-4 text-purple-600">
      Used Books
    </h3>

    <div class="space-y-3">

      <button onclick="openPostBook()"
              class="w-full bg-purple-600 text-white py-2 rounded-lg">
        üìö I want to sell my book
      </button>

      <button onclick="openRequestBook()"
              class="w-full bg-indigo-600 text-white py-2 rounded-lg">
        üîç I need a book
      </button>

      <button onclick="openBooks()"
              class="w-full border border-purple-600 text-purple-600 py-2 rounded-lg">
        üìñ View catalogue
      </button>

    </div>

    <button onclick="closeBooksHub()"
            class="mt-4 w-full text-sm text-gray-500">
      Cancel
    </button>

  </div>
</div>


<div id="postBookModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-50 flex items-center justify-center overflow">
  <div class="bg-white rounded-xl w-11/12 max-w-md p-6 max-h-[70vh] overflow-y-auto">
    <h3 class="text-center font-bold text-lg mb-4 text-purple-600">Sell Books</h3>
    
    <form id="postBookForm" class="space-y-3">
      
      <div class="bg-purple-50 p-3 rounded-lg space-y-2 mb-4">
        <label class="text-xs font-bold text-purple-700 uppercase">Seller Info</label>
        <input type="tel" name="phoneNumber" placeholder="WhatsApp or Phone Number" class="w-full border border-gray-300 rounded-lg p-2" required>
        <input type="text" name="location" placeholder="City or Town (e.g. Owerri, Lagos)" class="w-full border border-gray-300 rounded-lg p-2" required>
      </div>

      <div id="bookEntriesContainer" class="space-y-4">
        <!-- JavaScript will insert book fields here -->
      </div>
      
      <button type="button" onclick="addBookEntry()" class="w-full border-2 border-dashed border-purple-300 text-purple-600 py-2 rounded-lg">
        + Add Another Book
      </button>

      <hr class="my-4">
      <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg font-bold">Post All Books</button>
    </form>
    
    <button onclick="closePostBookModal()" class="mt-3 w-full text-sm text-gray-500">Cancel</button>
  </div>
</div>

<!-- Request a Book Modal -->
<div id="requestBookModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-50 flex items-center justify-center scale-[0.7]">
  <div class="bg-white rounded-xl w-11/12 max-w-md p-6">
    <h3 class="text-center font-bold text-lg mb-4 text-purple-600">Request a Book</h3>
    <form id="requestBookForm" class="space-y-3">
      <input type="text" name="title" placeholder="Book Title" class="w-full border border-gray-300 rounded-lg p-2" required>
      <input type="text" name="author" placeholder="Author" class="w-full border border-gray-300 rounded-lg p-2">
      <input type="text" name="location" placeholder="Your City or Town" class="w-full border border-gray-300 rounded-lg p-2" required>
      
      <!-- Added Phone Field -->
      <input type="tel" name="phoneNumber" placeholder="WhatsApp or Phone Number" class="w-full border border-gray-300 rounded-lg p-2" required>
      
      <textarea name="notes" placeholder="Additional Notes" class="w-full border border-gray-300 rounded-lg p-2"></textarea>
      <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg">Submit Request</button>
    </form>
    <button onclick="closeRequestBookModal()" class="mt-3 w-full text-sm text-gray-500">Cancel</button>
  </div>
</div>

<!-- Final Books Catalogue Modal -->
<div id="booksCatalogueModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-40 overflow-auto flex items-start justify-center py-10">
  <div class="bg-white rounded-xl w-11/12 max-w-3xl p-6 shadow-2xl">
    <h3 class="text-center font-bold text-lg mb-4 text-purple-600">Books Catalogue</h3>

    <div class="space-y-3 mb-4">
      <input type="text" id="catalogueSearch" onkeyup="renderCatalogue()" 
             placeholder="Search title, author, or location..." 
             class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-purple-500">
      
      <div class="flex justify-center gap-2">
        <button id="btnShowSale" onclick="toggleCatalogueView('sale')" 
                class="px-4 py-1 rounded-full bg-purple-600 text-white text-sm">Available for Sale</button>
        <button id="btnShowRequests" onclick="toggleCatalogueView('request')" 
                class="px-4 py-1 rounded-full bg-gray-200 text-gray-700 text-sm">User Requests</button>
      </div>
    </div>

    <!-- Container for dynamic cards -->
    <div id="catalogueList" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto p-1">
      <!-- JavaScript will inject cards here -->
    </div>

    <button onclick="closeBooksCatalogueModal()" class="mt-4 w-full py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition">
      Close
    </button>
  </div>
</div>




<!-- Load Google Identity Services -->


<div id="g_id_onload"
         data-client_id="845525258490-kr08g5n00eevukimo32mdaf65pjc25md.apps.googleusercontent.com"
         data-context="signin"
         data-ux_mode="popup"
         data-callback="handleCredentialResponse"
         data-nonce=""
         data-auto_select="true"
         data-itp_support="true">
</div>



<div id="teacherAdOverlay" class="flex space-x-4 overflow-x-auto p-2 snap-x snap-mandatory"></div>




<!-- üìö MENU PANEL -->
<div id="menuPanel"
     class="fixed left-0 top-0 h-full w-40 bg-white shadow-xl transform -translate-x-full transition-transform duration-300 z-40 overflow-y-auto">
    
    <div class="scale-[0.7] mt-7">
  <!-- Menu Content -->
    <div class="p-4">
        <button class="year-btn font-semibold text-gray-700 w-full text-left bg-red-100 rounded-lg" data-year="2020">GMAT‚ñº</button>
        <button class="year-btn font-semibold text-gray-700 w-full text-left hidden" data-year="2020">13th Edition ‚ñº</button>
        <ul class="subject-list hidden ml-4 mt-1 space-y-1">
          <li><button onclick="loadPastQuestions(13, 'Quantitative', 'GMAT')" class="subject-btn"> Quantitative</button></li><br>
          <li><button onclick="loadPastQuestions(13, 'problemSolving1', 'GMAT')" class="subject-btn"> Problem solving Part1</button></li><br>
          <li><button onclick="loadPastQuestions(13, 'problemSolving2', 'GMAT')" class="subject-btn">Problem Solving Part2</button></li><br>
          <li><button onclick="loadPastQuestions(13, 'problemSolving3', 'GMAT')" class="subject-btn">Problem Solving Part3</button></li><br>
          <li><button onclick="loadPastQuestions(13, 'problemSolving4', 'GMAT')" class="subject-btn">Problem Solving Part4</button></li><br>
          <li><button onclick="loadPastQuestions(13, 'problemSolving5', 'GMAT')" class="subject-btn">Problem Solving Part5</button></li><br>
          <li><button onclick="loadPastQuestions(13, 'problemSolving6', 'GMAT')" class="subject-btn">Problem Solving Part6</button></li>
        </ul>  
    </div>




<div class="p-4 " >

  <!-- MAIN MENU BUTTON -->
  <button class="year-btn font-semibold text-gray-700 w-full text-left bg-green-100 rounded-lg">
  COMMON ENTRANCE ‚ñº
  </button>


  <!-- MUST be a subject-list so the JS can toggle it -->
  <ul class="subject-list hidden space-y-3">

    <!-- 2020 -->
    <li>
      <button class="year-btn font-semibold text-gray-700 w-full text-left ">2020 ‚ñº</button>
      <ul class="subject-list hidden ml-4 mt-1 space-y-1">
        <li><button onclick="loadPastQuestions(2020,'maths','common_entrance')" class="subject-btn">*Mathematics</button></li><br>
        <li><button onclick="loadPastQuestions(2020,'verbal_and_vocational_aptitude','common_entrance')" class="subject-btn">Verbal & Vocational Aptitude</button></li><br>
        <li><button onclick="loadPastQuestions(2020,'basic_science','common_entrance')" class="subject-btn">*Basic science</button></li>
      </ul>
    </li>

    <!-- 2021 -->
    <li>
      <button class="year-btn font-semibold text-gray-700 w-full text-left">2021 ‚ñº</button>
      <ul class="subject-list hidden ml-4 mt-1 space-y-1">
        <li><button onclick="loadPastQuestions(2021,'english','common_entrance')" class="subject-btn">*English</button></li><br>
        <li><button onclick="loadPastQuestions(2021,'maths','common_entrance')" class="subject-btn">*Mathematics</button></li><br>
        <li><button onclick="loadPastQuestions(2021,'basic_science','common_entrance')" class="subject-btn">*Basic science</button></li><br>
        <li><button onclick="loadPastQuestions(2021,'verbal_and_vocational_aptitude','common_entrance')" class="subject-btn">Verbal & Vocational Aptitude</button></li>
      </ul>
    </li>

    <!-- 2022 -->
    <li>
      <button class="year-btn font-semibold text-gray-700 w-full text-left">2022 ‚ñº</button>
      <ul class="subject-list hidden ml-4 mt-1 space-y-1">
        <li><button onclick="loadPastQuestions(2022,'english','common_entrance')" class="subject-btn">*English</button></li><br>
        <li><button onclick="loadPastQuestions(2022,'maths','common_entrance')" class="subject-btn">*Mathematics</button></li><br>
        <li><button onclick="loadPastQuestions(2022,'basic_science','common_entrance')" class="subject-btn">*Basic science</button></li><br>
        <li><button onclick="loadPastQuestions(2022,'basic_studies','common_entrance')" class="subject-btn">*Basic studies</button></li>
      </ul>
    </li>

    <!-- 2023 -->
    <li>
      <button class="year-btn font-semibold text-gray-700 w-full text-left">2023 ‚ñº</button>
      <ul class="subject-list hidden ml-4 mt-1 space-y-1">
        <li><button onclick="loadPastQuestions(2023,'english','common_entrance')" class="subject-btn">*English</button></li><br>
        <li><button onclick="loadPastQuestions(2023,'maths','common_entrance')" class="subject-btn">*Mathematics</button></li><br>
        <li><button onclick="loadPastQuestions(2023,'Quantitative_aptitude','common_entrance')" class="subject-btn">Quantitative aptitude</button></li><br>
        <li><button onclick="loadPastQuestions(2023,'verbal_aptitude','common_entrance')" class="subject-btn">Verbal aptitude</button></li>
      </ul>
    </li>

    <!-- 2024 -->
    <li>
      <button class="year-btn font-semibold text-gray-700 w-full text-left">2024 ‚ñº</button>
      <ul class="subject-list hidden ml-4 mt-1 space-y-1">
        <li><button onclick="loadPastQuestions(2024,'english','common_entrance')" class="subject-btn">*English</button></li><br>
        <li><button onclick="loadPastQuestions(2024,'maths','common_entrance')" class="subject-btn">*Mathematics</button></li><br>
        <li><button onclick="loadPastQuestions(2024,'basic_technology','common_entrance')" class="subject-btn">*Basic technology</button></li><br>
        <li><button onclick="loadPastQuestions(2024,'social_studies','common_entrance')" class="subject-btn">*Social studies</button></li><br>
        <li><button onclick="loadPastQuestions(2024,'basic_science','common_entrance')" class="subject-btn">*Basic science</button></li><br>
        <li><button onclick="loadPastQuestions(2024,'civic_education','common_entrance')" class="subject-btn">*Civic education</button></li><br>
        <li><button onclick="loadPastQuestions(2024,'computer_studies','common_entrance')" class="subject-btn">*Computer St.</button></li><br>
        <li><button onclick="loadPastQuestions(2024,'physical_and_health_education','common_entrance')" class="subject-btn">*PHE</button></li>
      </ul>
    </li>

  </ul>
</div>




<div class="p-4">

  <!-- MAIN JAMB BUTTON -->
  <button class="year-btn font-semibold text-gray-700 w-full text-left bg-blue-100 rounded-lg">JAMB ‚ñº</button>

  <!-- MUST be subject-list so JS can toggle it -->
  <ul class="subject-list hidden space-y-3">

    <!-- 2020 -->
    <li>
      <button class="year-btn font-semibold text-gray-700 w-full text-left ">2020 ‚ñº</button>
      <ul class="subject-list hidden ml-4 mt-1 space-y-1">
        <li><button onclick="loadPastQuestions(2020,'english','jamb')" class="subject-btn">English</button></li><br>
        <li><button onclick="loadPastQuestions(2020,'maths','jamb')" class="subject-btn">Maths</button></li><br>
        <li><button onclick="loadPastQuestions(2020,'physics','jamb')" class="subject-btn">Physics</button></li><br>
        <li><button onclick="loadPastQuestions(2020,'chemistry','jamb')" class="subject-btn">Chemistry</button></li><br>
        <li><button onclick="loadPastQuestions(2020,'biology','jamb')" class="subject-btn">Biology</button></li><br>
        <li><button onclick="loadPastQuestions(2020,'economics','jamb')" class="subject-btn">Economics</button></li><br>
        <li><button onclick="loadPastQuestions(2020,'literature','jamb')" class="subject-btn">English Literature</button></li>
      </ul>
    </li>

    <!-- 2021 -->
    <li>
      <button class="year-btn font-semibold text-gray-700 w-full text-left">2021 ‚ñº</button>
      <ul class="subject-list hidden ml-4 mt-1 space-y-1">
        <li><button onclick="loadPastQuestions(2021,'english','jamb')" class="subject-btn">English</button></li><br>
        <li><button onclick="loadPastQuestions(2021,'maths','jamb')" class="subject-btn">Maths</button></li><br>
        <li><button onclick="loadPastQuestions(2021,'physics','jamb')" class="subject-btn">Physics</button></li><br>
        <li><button onclick="loadPastQuestions(2021,'chemistry','jamb')" class="subject-btn">Chemistry</button></li><br>
        <li><button onclick="loadPastQuestions(2021,'biology','jamb')" class="subject-btn">Biology</button></li><br>
        <li><button onclick="loadPastQuestions(2021,'economics','jamb')" class="subject-btn">Economics</button></li><br>
        <li><button onclick="loadPastQuestions(2021,'literature','jamb')" class="subject-btn">English Literature</button></li>
      </ul>
    </li>

    <!-- 2022 -->
    <li>
      <button class="year-btn font-semibold text-gray-700 w-full text-left">2022 ‚ñº</button>
      <ul class="subject-list hidden ml-4 mt-1 space-y-1">
        <li><button onclick="loadPastQuestions(2022,'english','jamb')" class="subject-btn">English</button></li><br>
        <li><button onclick="loadPastQuestions(2022,'maths','jamb')" class="subject-btn">Maths</button></li><br>
        <li><button onclick="loadPastQuestions(2022,'physics','jamb')" class="subject-btn">Physics</button></li><br>
        <li><button onclick="loadPastQuestions(2022,'chemistry','jamb')" class="subject-btn">Chemistry</button></li><br>
        <li><button onclick="loadPastQuestions(2022,'biology','jamb')" class="subject-btn">Biology</button></li><br>
        <li><button onclick="loadPastQuestions(2022,'economics','jamb')" class="subject-btn">Economics</button></li><br>
        <li><button onclick="loadPastQuestions(2022,'literature','jamb')" class="subject-btn">English Literature</button></li>
      </ul>
    </li>

    <!-- 2023 -->
    <li>
      <button class="year-btn font-semibold text-gray-700 w-full text-left">2023 ‚ñº</button>
      <ul class="subject-list hidden ml-4 mt-1 space-y-1">
        <li><button onclick="loadPastQuestions(2023,'english','jamb')" class="subject-btn">English</button></li><br>
        <li><button onclick="loadPastQuestions(2023,'maths','jamb')" class="subject-btn">Maths</button></li><br>
        <li><button onclick="loadPastQuestions(2023,'physics','jamb')" class="subject-btn">Physics</button></li><br>
        <li><button onclick="loadPastQuestions(2023,'chemistry','jamb')" class="subject-btn">Chemistry</button></li><br>
        <li><button onclick="loadPastQuestions(2023,'biology','jamb')" class="subject-btn">Biology</button></li><br>
        <li><button onclick="loadPastQuestions(2023,'economics','jamb')" class="subject-btn">Economics</button></li><br>
        <li><button onclick="loadPastQuestions(2023,'literature','jamb')" class="subject-btn">English Literature</button></li>
      </ul>
    </li>

  </ul>

</div>


    <div class="p-4">
        <button class="year-btn font-semibold text-gray-700 w-full text-left bg-red-100 rounded-lg" data-year="2020">ACCA‚ñº</button>
        <button class="year-btn font-semibold text-gray-700 w-full text-left hidden" data-year="2020">2023 ‚ñº</button>
        <ul class="subject-list hidden ml-4 mt-1 space-y-1">
          <li><button onclick="loadPastQuestions(2023, 'F1', 'ACCA')">F1</button></li><br>
          <li><button onclick="loadPastQuestions(2023, 'F3_A', 'ACCA')" class="subject-btn">F3 Section A</button></li><br>
          <li><button onclick="loadMTQQuestions(2023, 'F3_B', 'ACCA')" class="subject-btn">F3 Section B</button></li><br>
          <li><button onclick="loadMTQQuestions(2023, 'F3_C', 'ACCA')" class="subject-btn">F3 Section C</button></li>
        </ul>  
    </div>

  

  
</div>

<div class="flex justify-end">
        <button id="closeMenuBtn" 
            class="
            px-4 py-2 
            bg-gray-500 hover:bg-gray-600 
            text-white hover:text-white
            rounded-lg 
            fixed left-6 z-50 bottom-[15vh]
            shadow-md
            ">
        close
        </button>

  
    </div>


</div>

    
     

<!-- Public Feed -->
    <div id="feed" class="mt-6 space-y-4"></div> 
</div>




<!-- Floating Open Button -->
<button id="openMenuBtn"
        class="fixed top-4 left-4 bg-orange-600 wd-24 text-white rounded-full p-3 shadow-md hover:bg-blue-700 z-50 scale-[0.7]">
  Past questions
</button>





    <!-- Background shapes -->
    <div class="shape circle w-32 h-32 top-20 left-10 rotate"></div>
    <div class="shape triangle top-1/4 right-20 bounce"></div>
    <div class="shape square w-24 h-24 bottom-1/3 left-1/4 rotate"></div>
    <div class="shape pentagon bottom-20 right-1/4 pulse"></div>
    <div class="shape circle w-40 h-40 bottom-10 right-10 rotate"></div>
    <div class="shape triangle top-1/3 left-1/3 bounce"></div>
    
   
        


<!-- === Main App Wrapper === -->
<div id="main-content" class="hidden">
   
<!-- === Public Feed Section === -->
  <main id="publicFeed" class="max-w-3xl mx-auto p-6 space-y-6" >
    
    
    <!-- Feed will be populated dynamically from past questions -->
  </main>  

  <!-- === Step-Based Quiz Flow === -->
  <main id="app" class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 hidden">

    <!-- Step 1: Upload -->
    <div id="step1" class="step">
      <h2 class="text-2xl font-bold text-indigo-600 mb-6">Step 1: Upload Your School Notes</h2>
      <div id="dropArea" class="upload-container rounded-xl p-8 text-center cursor-pointer mb-6">
        <p class="text-gray-500 mb-4">Drag & drop your file or click to upload</p>
        <input type="file" id="fileInput" class="hidden" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
        <button id="uploadBtn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700">Choose File</button>
      </div>
    </div>

    <!-- Step 2: Extracted Text -->
    <div id="step2" class="step hidden">
      <h2 class="text-2xl font-bold text-indigo-600 mb-6">Step 2: Here's What We Found</h2>
      <div id="extractedText" class="bg-gray-100 p-6 rounded-xl mb-6 text-gray-700 whitespace-pre-line"></div>
      <button id="nextStep2" class="bg-indigo-600 text-white px-6 py-2 rounded-full">Next: Simplify</button>
    </div>

    <!-- Step 3: Simplified Summary -->
    <div id="step3" class="step hidden">
      <h2 class="text-2xl font-bold text-indigo-600 mb-6">Step 3: Simple Version</h2>
      <div id="simplifiedText" class="summary-box p-6 text-gray-700 mb-6"></div>
      <button id="nextStep3" class="bg-indigo-600 text-white px-6 py-2 rounded-full">Next: Make a Quiz</button>
    </div>

    <!-- Step 4: Quiz Options -->
    <div id="step4" class="step hidden">
      <h2 class="text-2xl font-bold text-indigo-600 mb-6">Step 4: Quiz Time!</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <button class="quiz-option bg-indigo-100 text-indigo-700 py-4 rounded-xl font-bold text-xl" data-questions="5">5</button>
        <button class="quiz-option bg-indigo-100 text-indigo-700 py-4 rounded-xl font-bold text-xl" data-questions="10">10</button>
        <button class="quiz-option bg-indigo-100 text-indigo-700 py-4 rounded-xl font-bold text-xl" data-questions="15">15</button>
        <button class="quiz-option bg-indigo-100 text-indigo-700 py-4 rounded-xl font-bold text-xl" data-questions="20">20</button>
      </div>
      <button id="nextStep4" class="bg-indigo-600 text-white px-6 py-2 rounded-full">Create My Quiz</button>
    </div>
    <div id="loading" class="hidden">Loading...</div>


    <!-- Step 5: Quiz -->
    <div id="step5" class="step hidden scale-[0.99]">
      <h2 class="text-2xl font-bold text-indigo-600 mb-6">Step 5: Let's Test Your Knowledge!</h2>
      <div id="quizContainer" class="mb-8"></div>
      <div id="results" class="mt-6"></div>

      <button id="submitQuiz" class="bg-indigo-600 text-white px-6 py-2 rounded-full">Submit Quiz</button>
      

      <button id="closeQuiz" class="ml-2 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">Close</button>

    </div>

    

    <!-- Step 6: Results -->
    <div id="step6" class="step hidden">
      <h2 class="text-2xl font-bold text-indigo-600 mb-6">Step 6: Your Results</h2>
      
      <div class="text-center mb-8  "  >
        <div id="score" class="inline-block bg-indigo-100 text-indigo-800 text-4xl font-bold rounded-full w-32 h-32 flex items-center justify-center ">0%</div>
        <p id="resultMessage" class="text-xl text-gray-700 mt-2 "></p>

      </div>
      
      <div id="wrongAnswers" class="mb-8 " ></div>
      <button id="restartQuiz" class="bg-indigo-600 text-white px-6 py-2 rounded-full">Try Again</button>
      <button id="newDocument" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-full">New Document</button>
    </div>

    <!-- Step 7: Story Feed -->
    <div id="step7" class="step hidden">
      <h2 class="text-2xl font-bold text-indigo-600 mb-6">Story Feed</h2>
      <textarea id="storyInput" rows="3" class="w-full border border-gray-300 rounded-lg p-2 mb-3" placeholder="Share your quiz idea..."></textarea>
      <button id="postStoryBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-full mb-6">Post Story</button>
      <div id="storyFeed" class="space-y-4"></div>

      
</div>

    </div>

    <!-- Step 8: MTQ Results -->
<div id="step8" class="step hidden">
  <h2 class="text-2xl font-bold text-indigo-600 mb-6">MTQ Results</h2>

  <!-- Only MTQ results container is visible -->
  <div id="resultsContainer" class="mt-4 " ></div>

  <!-- Hidden MCQ elements (so Step 8 can reuse Step 6‚Äôs layout style if needed) -->
  <div id="mtqScoreWrapper" class="hidden">
    <div id="mtqScore" class="inline-block bg-indigo-100 text-indigo-800 text-4xl font-bold rounded-full w-32 h-32 flex items-center justify-center"></div>
    <p id="mtqMessage" class="text-xl text-gray-700 mt-2"></p>
  </div>

  <!-- Buttons -->
  <button id="restartMTQ" class="bg-indigo-600 text-white px-6 py-2 rounded-full">Try Again</button>
  <button id="newDocumentMTQ" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-full">New Document</button>
</div>


    

  </main>
</div>

<!-- Bottom Nav -->
<div id="bottomNav"
     class="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t 
            flex justify-around items-center py-2 z-50 scale-[1] origin-bottom">

  <!-- Home -->
  <div class="text-center cursor-pointer">
    <p class="text-xs text-orange-600">More past questions?</p>
    <span class="material-icons text-orange-600" onclick="home()">home</span>
    <p class="text-xs text-orange-600">click</p>
  </div>

<!-- Requests Button (with red badge) -->
<div class="relative text-center cursor-pointer" onclick="openRequests()">
    <p class="text-green-600 text-xs">Do u need a teacher?</p>
    <span class="material-icons text-green-600">list</span>
    <p class="text-green-600 text-xs"> Meet our teachers +</p>

    <span id="badge"
        class="hidden absolute -top-1 -right-2 bg-red-600 text-white 
               text-xs w-5 h-5 flex items-center justify-center rounded-full">
        0
    </span>
</div>

<div id="openBooksHub"
     class="text-center cursor-pointer"
     onclick="openBooksHub()">

  <p class="text-xs text-blue-500 font-semibold">
    want to sell old books? +
  </p>

  <span class="material-icons text-blue-500">
    menu_book
  </span>

  <p class="text-xs text-blue-500 font-semibold">
    want a particular book? +
  </p>

</div>



  <!-- Teacher Post -->
  <div id="openTeacherPost" class="text-center cursor-pointer" onclick="openTeacherPost()">
    <p class="text-xs text-purple-600 font-semibold">Are you a Teacher? </p>
    <span class="material-icons text-purple-600">school</span>
    <p class="text-xs text-purple-600 font-semibold"> post ad</p>
  </div>

  

  <!-- Profile -->
  <!--div onclick="openProfile()" class="text-center cursor-pointer">
    <img id="footerProfile"
         class="w-8 h-8 rounded-full mx-auto object-cover border"
         src="https://via.placeholder.com/150" />
    <p class="text-xs">You</p>
  </div-->
</div>

<!-- Teacher Profiles Modal -->
<div id="teacherModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-4xl max-h-[85vh] flex flex-col shadow-2xl">
        <!-- Header -->
        <div class="p-5 border-b flex justify-between items-center bg-green-600 text-white rounded-t-xl">
            <h2 class="text-xl font-bold">Available Teachers</h2>
            <button onclick="closeModal()" class="hover:bg-green-700 p-1 rounded-full transition">
                <span class="material-icons">close</span>
            </button>
        </div>
        
        <!-- Profile Grid -->
        <div id="profileGrid" class="p-6 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Dynamic cards will appear here -->
        </div>
    </div>
</div>

<!-- Teachers Catalogue Modal -->
<div id="teachersCatalogueModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl">
        <!-- Header -->
        <div class="p-4 border-b flex justify-between items-center bg-green-600 text-white rounded-t-2xl">
            <h2 class="text-xl font-bold">Our Teachers</h2>
            <button onclick="closeTeachersModal()" class="text-white hover:bg-green-700 rounded-full p-1 transition">
                <span class="material-icons">close</span>
            </button>
        </div>

        <!-- Filter Bar -->
        <div class="p-4 border-b bg-white flex flex-col sm:flex-row gap-3">
            <div class="relative flex-1">
                <input type="text" id="teacherSearch" oninput="filterTeachers()" placeholder="Search name or subject..." 
                       class="w-full pl-3 pr-3 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <select id="genderFilter" onchange="filterTeachers()" class="py-2 px-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500">
                <option value="">All Genders</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
        </div>

        <!-- Teacher List Container -->
        <div id="teacherList" class="p-6 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 bg-gray-50">
            <!-- Cards will be injected here -->
        </div>
    </div>
</div>

<!-- üîã Top Up Wallet Modal -->
<div id="topupModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 transition-all">
  <!-- Modal Container -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all">
    
    <!-- Header -->
    <div class="flex justify-between items-start mb-4">
      <div>
        <h2 class="text-2xl font-bold text-gray-800">Top Up Wallet</h2>
        <p class="text-sm text-gray-500">Select a package to continue</p>
      </div>
      <button onclick="closeTopupModal()" class="text-gray-400 hover:text-gray-600 p-1">
        <svg xmlns="www.w3.org" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Coin Options -->
    <div class="space-y-3">
      <button onclick="selectTopup(100)" class="group w-full border-2 border-gray-100 rounded-xl p-4 flex justify-between items-center hover:border-blue-500 hover:bg-blue-50 transition-all duration-200">
        <div class="flex items-center gap-3">
          <span class="text-2xl">üí∞</span>
          <span class="font-semibold text-gray-700 group-hover:text-blue-700">100 Coins</span>
        </div>
        <span class="bg-gray-100 px-3 py-1 rounded-lg text-sm font-bold text-gray-600 group-hover:bg-blue-100 group-hover:text-blue-700">‚Ç¶1,000</span>
      </button>

      <button onclick="selectTopup(250)" class="group w-full border-2 border-gray-100 rounded-xl p-4 flex justify-between items-center hover:border-blue-500 hover:bg-blue-50 transition-all duration-200">
        <div class="flex items-center gap-3">
          <span class="text-2xl">ü™ô</span>
          <span class="font-semibold text-gray-700 group-hover:text-blue-700">250 Coins</span>
        </div>
        <span class="bg-gray-100 px-3 py-1 rounded-lg text-sm font-bold text-gray-600 group-hover:bg-blue-100 group-hover:text-blue-700">‚Ç¶2,000</span>
      </button>

      <button onclick="selectTopup(500)" class="group w-full border-2 border-gray-100 rounded-xl p-4 flex justify-between items-center hover:border-blue-500 hover:bg-blue-50 transition-all duration-200">
        <div class="flex items-center gap-3">
          <span class="text-2xl">üíé</span>
          <span class="font-semibold text-gray-700 group-hover:text-blue-700">500 Coins</span>
        </div>
        <span class="bg-gray-100 px-3 py-1 rounded-lg text-sm font-bold text-gray-600 group-hover:bg-blue-100 group-hover:text-blue-700">‚Ç¶3,000</span>
      </button>
    </div>

    <!-- Footer -->
    <div class="mt-6">
      <button onclick="closeTopupModal()" class="w-full py-3 text-gray-500 font-medium hover:text-gray-700 transition-colors">
        Maybe Later
      </button>
    </div>
  </div>
</div>













 




<script>

const firebaseConfig = {
    apiKey: "AIzaSyA2WYxbeUFMxy6UF_lP7B0PK01vhrwgSTI",
    authDomain: "kids-note-app.firebaseapp.com",
    projectId: "kids-note-app",
    storageBucket: "kids-note-app.appspot.com",
    messagingSenderId: "845525258490",
    appId: "1:845525258490:web:16ab8dad0a98469456b943",
    measurementId: "G-KHBK5Z52TL"
  };

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
   
const functions = firebase.functions();

function handleCredentialResponse(response) {
  const credential = firebase.auth.GoogleAuthProvider.credential(response.credential);

  auth.signInWithCredential(credential)
    .then(result => {
      const user = result.user;

      const firstName =
        user.displayName?.split(" ")[0] || "User";

      // Update UI
      titleElement.textContent = `GoQuiz ${firstName}`;

      // ‚úÖ Save REQUIRED login data
      localStorage.setItem("firstName", firstName);
      localStorage.setItem("userUid", user.uid); 

      console.log("Logged in as:", user.uid);
    })
    .catch(err => {
      console.error("Firebase sign-in failed:", err);
    });
}


 
  // ------------------------------
  // App State
  // ------------------------------
const appState = {
    currentStep: 1,
    extractedText: '',
    simplifiedText: '',
    quizQuestions: 5,
    quizData: [],
    userAnswers: [],
    score: 0
};


let selectedDateTime = null;

flatpickr("#reqDateTime", {
  enableTime: true,
  dateFormat: "Y-m-d H:i",
  minDate: "today",
  time_24hr: true,
  onChange: function (selectedDates) {
    if (selectedDates.length > 0) {
      selectedDateTime = selectedDates[0];
    }
  }
});


 

// Load user coins from localStorage on page load
let userCoins = parseInt(localStorage.getItem("userCoins")) || 0;

// Update coin display and persist
function updateCoinDisplay(amount = 0) {
  userCoins += amount;
  if (userCoins < 0) userCoins = 0; // don't go negative

  // Save to localStorage
  localStorage.setItem("userCoins", userCoins);

  // Update UI
  const coinNumber = document.getElementById("coinNumber");
  if (coinNumber) coinNumber.textContent = userCoins;

  // Trigger flash animation
  const coinSvg = document.getElementById("gqCoin");
  if (coinSvg) {
    coinSvg.classList.remove("flash"); // reset
    void coinSvg.offsetWidth;          // trigger reflow
    coinSvg.classList.add("flash");    // add animation
  }
}



// Initialize display on page load
updateCoinDisplay(0);



  // ------------------------------
  // MENU PANEL LOGIC
  // ------------------------------
  const menuPanel = document.getElementById('menuPanel');
  const openMenuBtn = document.getElementById('openMenuBtn');
  const closeMenuBtn = document.getElementById('closeMenuBtn');

  openMenuBtn.addEventListener('click', () => menuPanel.classList.remove('-translate-x-full'));
  closeMenuBtn.addEventListener('click', () => menuPanel.classList.add('-translate-x-full'));

  document.querySelectorAll('.year-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const nextList = btn.nextElementSibling;
      nextList.classList.toggle('hidden');
    });
  });
 
  

  // ------------------------------
  // Initialize AOS & Feather Icons
  // ------------------------------
  document.addEventListener('DOMContentLoaded', () => {
    AOS.init({ duration: 800, easing: 'ease-in-out', once: true });
    feather.replace();
    setupApp();  // Start main app logic
  });

  // ------------------------------
  // MAIN APP LOGIC
  // ------------------------------
  function setupApp() {
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const nextStep2 = document.getElementById('nextStep2');
    const nextStep3 = document.getElementById('nextStep3');
    const nextStep4 = document.getElementById('nextStep4');
    const submitQuiz = document.getElementById('submitQuiz');
    const restartQuiz = document.getElementById('restartQuiz');
    const newDocument = document.getElementById('newDocument');
    const quizOptions = document.querySelectorAll('.quiz-option');
    const closeQuiz = document.getElementById('closeQuiz');


    


    // Event listeners
    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);

    ['dragenter','dragover','dragleave','drop'].forEach(event => {
      dropArea.addEventListener(event, e => { e.preventDefault(); e.stopPropagation(); }, false);
    });

    ['dragenter','dragover'].forEach(event => dropArea.addEventListener(event, () => dropArea.classList.add('border-indigo-500','bg-indigo-50')));
    ['dragleave','drop'].forEach(event => dropArea.addEventListener(event, () => dropArea.classList.remove('border-indigo-500','bg-indigo-50')));
    dropArea.addEventListener('drop', handleDrop);

    nextStep2.addEventListener('click', () => showStep(3));
    nextStep3.addEventListener('click', () => showStep(4));
    nextStep4.addEventListener('click', () => generateQuiz());
    submitQuiz.addEventListener('click', calculateScore);
    restartQuiz.addEventListener('click', restartQuizFunc);
    newDocument.addEventListener('click', () => showStep(1));

    closeQuiz.addEventListener('click', () => {
    document.getElementById('app').classList.add('hidden');
    home();
    window.scrollTo({ top: 0, behavior: 'smooth' });
});

 



    quizOptions.forEach(option => {
      option.addEventListener('click', function(){
        quizOptions.forEach(opt => opt.classList.remove('bg-indigo-200'));
        this.classList.add('bg-indigo-200');
        appState.quizQuestions = parseInt(this.dataset.questions);
      });
    });

    // ------------------------------
    // FILE PROCESSING
    // ------------------------------
    function preventDefaults(e){ e.preventDefault(); e.stopPropagation(); }
    function highlight(){ dropArea.classList.add('border-indigo-500','bg-indigo-50'); }
    function unhighlight(){ dropArea.classList.remove('border-indigo-500','bg-indigo-50'); }
    function handleDrop(e){
      const dt = e.dataTransfer;
      const files = dt.files;
      if(files.length){ fileInput.files = files; handleFileSelect({ target: fileInput }); }
    }

    async function handleFileSelect(event){
      const files = Array.from(event.target.files);
      if(!files.length) return;

      showLoading("Processing your document...");
      simulateProgress();

      try {
        let text = '';
        for(const file of files){
          const fileType = file.name.split('.').pop().toLowerCase();
          if(fileType === 'pdf'){ text += await extractTextFromPDF(file)+'\n\n'; }
          else if(fileType === 'doc' || fileType === 'docx'){ text += await extractTextFromWord(file)+'\n\n'; }
          else if(['jpg','jpeg','png'].includes(fileType)){ text += await extractTextFromImage(file)+'\n\n'; }
          else { throw new Error('Unsupported file type: ' + file.name); }
        }
        appState.extractedText = text;
        document.getElementById('extractedText').textContent = text;
        appState.simplifiedText = await simplifyText(text);
        document.getElementById('simplifiedText').textContent = appState.simplifiedText;

        hideLoading();
        showStep(2);
      } catch(err){ hideLoading(); alert('Error processing file: '+err.message); }
    }
}

    
    function extractTextFromPDF(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const typedArray = new Uint8Array(e.target.result);
                    pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
                        let text = '';
                        const numPages = pdf.numPages;
                        
                        const getPageText = async (pageNum) => {
                            const page = await pdf.getPage(pageNum);
                            const textContent = await page.getTextContent();
                            const strings = textContent.items.map(item => item.str);
                            text += strings.join(' ') + '\n\n';
                            
                            if (pageNum < numPages) {
                                await getPageText(pageNum + 1);
                            } else {
                                resolve(text);
                            }
                        };
                        
                        getPageText(1);
                    });
                } catch (err) {
                    reject(err);
                }
            };
            
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }
    
    function extractTextFromWord(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                
                mammoth.extractRawText({ arrayBuffer: arrayBuffer })
                    .then(function(result) {
                        resolve(result.value);
                    })
                    .catch(function(error) {
                        reject(error);
                    });
            };
            
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }
    
    // ‚úÖ Google Vision OCR (via backend)
async function extractTextFromImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function (e) {
            try {
                const base64Data = e.target.result.split(',')[1]; // strip "data:image/png;base64,"
                const res = await fetch("/api/ocr", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ images: [base64Data] }) // üëà wrap in array
                });
                const data = await res.json();
                if (res.ok && data.text) {
                    resolve(data.text);
                } else {
                    reject(new Error(data.error || "OCR failed"));
                }
            } catch (err) {
                reject(err);
            }
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}


    
    async function simplifyText(text) {
        try {
            const res = await fetch("/api/simplify", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text })
            });
            const data = await res.json();
            if (res.ok && data.simplified) {
                return data.simplified;
            } else {
                return `Here's a simple version:\n\n${text.slice(0, 500)}...`;
            }
        } catch (err) {
            console.error("Simplify failed:", err);
            return `Here's a simple version:\n\n${text.slice(0, 500)}...`;
        }
    }
    
    async function generateQuiz() {
        showLoading("Creating your quiz...");
        try {
            const res = await fetch("/api/quiz", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    text: appState.simplifiedText,
                    numQuestions: appState.quizQuestions
                })
            });
            const data = await res.json();
            if (!res.ok || !Array.isArray(data.quiz)) {
                throw new Error("Quiz API error");
            }
            appState.quizData = data.quiz.map(q => ({
                question: q.question || "Untitled question",
                options: Array.isArray(q.options) ? q.options.slice(0,4) : ["A","B","C","D"],
                correct: letterToIndex(q.correct ?? q.answer) >= 0 ? letterToIndex(q.correct ?? q.answer) : 0,

            }));
            displayQuiz();
            hideLoading();
            showStep(5);
        } catch (error) {
            hideLoading();
            console.error("Error generating quiz:", error);
            alert("Problem creating quiz. Check console.");
        }
    }

    // ‚úÖ Added missing displayQuiz function
    function displayQuiz() {
  const quizContainer = document.getElementById('quizContainer');
  if (!quizContainer) return;

  // Guard: MCQ only
  if (!appState.quizData?.length || !appState.quizData[0].options) {
    console.warn("displayQuiz skipped (not MCQ data)");
    return;
  }

  quizContainer.innerHTML = '';

  // Initialize MCQ answers ONCE
  if (!Array.isArray(appState.userAnswers) ||
      appState.userAnswers.length !== appState.quizData.length) {
    appState.userAnswers = new Array(appState.quizData.length).fill(null);
  }

  appState.quizData.forEach((q, index) => {
    const questionDiv = document.createElement('div');
    questionDiv.className = "mb-6 p-4 bg-white shadow rounded-lg";

    const questionText = document.createElement('h4');
    questionText.className = "font-medium text-gray-800 mb-3";
    questionText.textContent = `Q${index + 1}: ${q.question}`;
    questionDiv.appendChild(questionText);

    const optionsDiv = document.createElement('div');
    optionsDiv.className = "grid grid-cols-1 gap-2";

    q.options.forEach((option, optIndex) => {
      const btn = document.createElement('button');
      btn.textContent = option;
      btn.className =
        "w-full text-left px-4 py-2 rounded-lg border border-gray-300 hover:bg-indigo-50 transition";

      // Restore selection
      if (appState.userAnswers[index] === optIndex) {
        btn.classList.add("bg-indigo-200");
      }

      btn.addEventListener('click', () => {
        appState.userAnswers[index] = optIndex;
        Array.from(optionsDiv.children).forEach(child =>
          child.classList.remove("bg-indigo-200")
        );
        btn.classList.add("bg-indigo-200");
      });

      optionsDiv.appendChild(btn);
    });

    questionDiv.appendChild(optionsDiv);
    quizContainer.appendChild(questionDiv);
  });
}


    function calculateScore() {
    let correctCount = 0;
    appState.quizData.forEach((q, i) => {
        if (appState.userAnswers[i] === q.correct) correctCount++;
    });
    appState.score = Math.round((correctCount / appState.quizData.length) * 100);

    // Update score circle
    document.getElementById('score').textContent = appState.score;

    // Set result message and award coins
    const resultMessage = document.getElementById('resultMessage');
    if (appState.score === 100) {
        resultMessage.textContent = "Perfect! You're a learning superstar!";
        updateCoinDisplay(10);
    } else if (appState.score >= 80) {
        resultMessage.textContent = "Great job! You know this well!";
        updateCoinDisplay(8);
    } else if (appState.score >= 60) {
        resultMessage.textContent = "Good effort! You're getting there!";
        updateCoinDisplay(3);
    } else if (appState.score >= 40) {
        resultMessage.textContent = "Keep practicing! You'll improve!";
        updateCoinDisplay(2);
    } else {
        resultMessage.textContent = "Nice try! Let's review and try again!";
        updateCoinDisplay(0);
    }

    // Prepare wrong answers review
    const wrongAnswersContainer = document.getElementById('wrongAnswers');
    wrongAnswersContainer.innerHTML = '';
    let hasWrongAnswers = false;

    appState.quizData.forEach((q, i) => {
        if (appState.userAnswers[i] !== q.correct) {
            hasWrongAnswers = true;
            const wrongAnswerElement = document.createElement('div');
            wrongAnswerElement.className = 'mb-6 p-4 bg-gray-100 rounded-lg';
            wrongAnswerElement.innerHTML = `
                <h4 class="font-medium text-gray-800 mb-2">Question: ${q.question}</h4>
                <p class="text-red-600 mb-1">Your answer: ${q.options[appState.userAnswers[i]] || 'Not answered'}</p>
                <p class="text-green-600">Correct answer: ${q.options[q.correct]}</p>
            `;
            wrongAnswersContainer.appendChild(wrongAnswerElement);
        }
    });

    if (!hasWrongAnswers) {
        wrongAnswersContainer.innerHTML = '<p class="text-center text-gray-600">You got all questions right! Amazing!</p>';
    }

    // SHOW RESULTS WITH FULL-SCREEN AD FOR FREE USERS
    showRegularQuizResultsWithAd();
}

function showRegularQuizResultsWithAd() {
    // 1. Premium users skip ad instantly
    if (adFreeUntil > Date.now()) {
        showStep(6);
        return;
    }

    // 2. Create the overlay
    const overlay = document.createElement("div");
    overlay.id = "regularQuizAdOverlay";
    overlay.className = "fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 overflow-hidden";

    // Only inject the HTML structure (NO <script> tags inside here)
    overlay.innerHTML = `
        <div class="text-center mb-8 max-w-md">
            <h2 class="text-3xl font-bold text-indigo-700 mb-4">Quiz Complete!</h2>
            <p class="text-lg text-gray-600">One quick ad before your score...</p>
        </div>

        <div class="w-full max-w-lg mx-auto" style="min-width: 250px; min-height: 100px;">
        <ins class="adsbygoogle"
        style="display:block; width:100%; min-width:250px;"
        data-ad-format="fluid"
        data-ad-layout-key="-e5+6n-34-bt+x0"
        data-ad-client="ca-pub-2721836557124559"
        data-ad-slot="2394125748">
        </ins>
        </div>


        <p class="text-sm text-gray-500 mt-8 italic text-indigo-400 animate-pulse">Processing results...</p>
    `;

    document.body.appendChild(overlay);

    // 3. Trigger the AdSense push NOW that the 'ins' tag is in the DOM
    try {
        (adsbygoogle = window.adsbygoogle || []).push({});
    } catch (e) {
        console.warn("AdSense failed to load (likely an ad-blocker).");
    }

    const showResults = () => {
        // Ensure we don't try to remove it twice
        if (document.getElementById("regularQuizAdOverlay")) {
            overlay.remove();
            showStep(6);
        }
    };

    // 4. Timers for UX
    // In 2026, users prefer faster transitions. Consider 5-7 seconds.
    setTimeout(showResults, 6000); 

    // Fallback security timer
    setTimeout(showResults, 9000);
}

function restartQuizFunc() {
    displayQuiz();
    showStep(5);
}

function showStep(stepNumber) {
    appState.currentStep = stepNumber;
    document.querySelectorAll('.step').forEach(step => step.classList.add('hidden'));
    document.getElementById(`step${stepNumber}`).classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showLoading(message) {
    document.getElementById('loadingMessage').textContent = message;
    document.getElementById('loading').classList.remove('hidden');
    document.querySelectorAll('.step').forEach(step => step.classList.add('hidden'));
}

function hideLoading() {
    document.getElementById('loading').classList.add('hidden');
}

function simulateProgress() {
    let progress = 0;
    const progressFill = document.getElementById('progressFill');
    const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
        }
        progressFill.style.width = `${progress}%`;
    }, 300);
}

// Convert letter "A"/"B"/"C"/"D" ‚Üí numeric index 0..3
function letterToIndex(letter) {
    if (!letter || typeof letter !== 'string') return -1;
    return ['A', 'B', 'C', 'D'].indexOf(letter.toUpperCase());
}

// Convert numeric index 0..3 ‚Üí letter "A"/"B"/"C"/"D"
function indexToLetter(idx) {
    return ['A', 'B', 'C', 'D'][idx] || null;
}


// Load MTQ quiz from JSON
async function loadMTQQuestions(year, subject, category = 'ACCA') {
    closeFeedBatch()
    const loader = document.getElementById('loading');
    if (loader) loader.style.display = 'block';

    try {
        console.log(`Loading ${category.toUpperCase()} ${subject.toUpperCase()} MTQs for ${year}...`);

        // Fetch the MTQ JSON
        const response = await fetch(`past_questions/${category}_${year}_${subject}.json`);
        if (!response.ok) throw new Error("Quiz not found");

        const data = await response.json();
        if (!Array.isArray(data.quiz)) throw new Error("Invalid quiz data");

        const quizData = data.quiz; // MTQ structure expected: tasks array per question

        // Get quiz container and reset
        const quizContainer = document.getElementById('quizContainer');
        if (!quizContainer) throw new Error("Missing #quizContainer element in DOM");
        quizContainer.innerHTML = '';

        // Initialize userAnswers as 2D array: question -> task
        appState.userAnswers = new Array(quizData.length).fill(null).map(() => []);

        // Render each MTQ question and its tasks
        quizData.forEach((q, qIndex) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = "mb-6 p-4 bg-white shadow rounded-lg";

            const questionText = document.createElement('h4');
            questionText.className = "font-medium text-gray-800 mb-3";
            questionText.textContent = `Q${qIndex + 1}: ${q.question || ''}`;
            questionDiv.appendChild(questionText);

            q.tasks.forEach((task, tIndex) => {
                const taskDiv = document.createElement('div');
                taskDiv.className = "mb-3";

                const inputType = task.input_type === 'number' ? 'number' : 'text';
                const inputField = document.createElement('input');
                inputField.type = inputType;
                inputField.className = "w-full p-2 border rounded";
                inputField.placeholder = task.input_type === 'number' ? 'Enter number' : 'Enter text';

                // Store user input dynamically
                inputField.addEventListener('input', e => {
                    appState.userAnswers[qIndex][tIndex] = e.target.value.trim();
                });

                const label = document.createElement('label');
                label.textContent = task.task || '';
                taskDiv.appendChild(label);
                taskDiv.appendChild(inputField);
                questionDiv.appendChild(taskDiv);
            });

            quizContainer.appendChild(questionDiv);
        });

        // Show the MTQ step once (after rendering)
        showStep(5);
        document.getElementById('menuPanel')?.classList.add('-translate-x-full');

        // Wire the submit button to calculateMTQScore using addEventListener
        const scoreBtn = document.getElementById('submitQuiz');
        if (!scoreBtn) throw new Error("Missing #submitQuiz element in DOM");

        // Remove any prior MTQ listener to avoid duplicate calls
        scoreBtn.removeEventListener('click', scoreBtn._mtqHandler || (() => {}));

        // Create handler and store it for potential removal later
        const handler = () => calculateMTQScore(quizData);
        scoreBtn._mtqHandler = handler;
        scoreBtn.addEventListener('click', handler);

    } catch (error) {
        console.error("Error loading MTQ quiz:", error);
        alert("Problem loading MTQ quiz. Check console.");
    } finally {
        if (loader) loader.style.display = 'none';
    }
}

window.loadMTQQuestions = loadMTQQuestions;



async function loadPastQuestions(year, subject, category = 'jamb') {
    closeFeedBatch()
    const loader = document.getElementById('loading');
    if (loader) loader.style.display = 'block';

    try {
      console.log(`Loading ${category.toUpperCase()} ${subject.toUpperCase()} past questions for ${year}...`);

      const response = await fetch(`past_questions/${category}_${year}_${subject}.json`);
      if (!response.ok) throw new Error("Quiz not found");

      const data = await response.json();
      if (!Array.isArray(data.quiz)) throw new Error("Invalid quiz data");

      const pastQuizData = data.quiz.map((q) => {
        let optionsArr = Array.isArray(q.options) 
          ? q.options.slice(0,4)
          : ['A','B','C','D'].map(k => q.options?.[k]).filter(v => v !== undefined);

        let correctVal = q.correct ?? q.answer ?? q.correctIndex ?? null;
        let correctIndex = typeof correctVal === 'string' ? letterToIndex(correctVal) : correctVal ?? 0;

        return {
          question: q.question || "Untitled question",
          options: optionsArr,
          correct: correctIndex
        };
      });

    appState.quizData = pastQuizData;
    appState.userAnswers = [];
    displayQuiz();
    showStep(5);
    document.getElementById('menuPanel')?.classList.add('-translate-x-full');

  } catch (err) {
    console.error("Failed to load past questions:", err);
    alert("Could not load past questions. See console for details.");
  } finally {
    if (loader) loader.style.display = 'none';
  }
}

window.loadPastQuestions = loadPastQuestions;

function calculateMTQScore(quizData) {
    const results = [];
    let totalTasks = 0;
    let correctTasks = 0;

    quizData.forEach((q, qIndex) => {
        q.tasks.forEach((task, tIndex) => {
            totalTasks++;

            const userAnswer = appState.userAnswers[qIndex][tIndex] ?? "";
            const correctAnswer = task.correct;

            let isCorrect = false;

            if (task.input_type === "number") {
                isCorrect = Number(userAnswer) === Number(correctAnswer);
            } else if (task.expected_keywords) {
                const ans = String(userAnswer).trim().toLowerCase();
                isCorrect = task.expected_keywords.some(kw =>
                    ans.includes(kw.toLowerCase())
                );
            } else {
                // Default: exact match (case-insensitive, trimmed)
                isCorrect =
                    String(userAnswer).trim().toLowerCase() ===
                    String(correctAnswer).trim().toLowerCase();
            }

            if (isCorrect) correctTasks++;

            results.push({
                questionNumber: qIndex + 1,
                taskLabel: task.task,
                userAnswer,
                correctAnswer,
                isCorrect
            });
        });
    });

    // ONLY CALL THIS ‚Äî it handles everything (ad + results)
    showMTQResultsWithAd(results, correctTasks, totalTasks);
}


window.calculateMTQScore = calculateMTQScore;



function renderMTQResults(results, correctTasks, totalTasks) {
    const container = document.getElementById('resultsContainer');
    container.innerHTML = '';

    const scoreDiv = document.createElement('div');
    scoreDiv.className = "p-4 mb-4 bg-blue-100 rounded shadow";
    scoreDiv.innerHTML = `
        <h3 class="text-xl font-semibold mb-2">MTQ Score</h3>
        <p><strong>${correctTasks}</strong> out of <strong>${totalTasks}</strong> tasks correct</p>
    `;
    container.appendChild(scoreDiv);

    results.forEach((r, idx) => {
        const div = document.createElement('div');
        div.className =
            'p-4 mb-3 rounded shadow ' +
            (r.isCorrect ? 'bg-green-100' : 'bg-red-100');

        div.innerHTML = `
            <h4 class="font-semibold">Q${r.questionNumber} ‚Äì ${r.taskLabel}</h4>
            <p><strong>Your Answer:</strong> ${r.userAnswer || "(blank)"}</p>
            <p><strong>Correct Answer:</strong> ${r.correctAnswer}</p>
            <p class="${r.isCorrect ? 'text-green-700' : 'text-red-700'} mt-1">
                ${r.isCorrect ? 'Correct ‚úî' : 'Wrong ‚úò'}
            </p>
        `;

        container.appendChild(div);
    });
}
function showMTQResultsWithAd(results, correctTasks, totalTasks) {
    // Premium users skip ad completely
    if (adFreeUntil > Date.now()) {
        renderMTQResults(results, correctTasks, totalTasks);
        showStep(8);
        return;
    }

    // Create overlay
    const overlay = document.createElement("div");
    overlay.id = "mtqAdOverlay";
    overlay.className =
        "fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 overflow-hidden";

    overlay.innerHTML = `
        <div class="text-center mb-8 max-w-md">
            <h2 class="text-3xl font-bold text-indigo-700 mb-4">
                Your Results Are Ready
            </h2>
            <p class="text-lg text-gray-600">
                Please wait while content loads
            </p>
        </div>

        <div class="w-full max-w-lg mx-auto">
            <ins class="adsbygoogle"
                style="display:block"
                data-ad-format="fluid"
                data-ad-layout-key="-e5+6n-34-bt+x0"
                data-ad-client="ca-pub-2721836557124559"
                data-ad-slot="2394125748">
            </ins>
        </div>

        <p class="text-sm text-gray-500 mt-8">
            This will close automatically‚Ä¶
        </p>
    `;

    document.body.appendChild(overlay);

    // Load AdSense script ONCE globally
    if (!window.adsenseLoaded) {
        const script = document.createElement("script");
        script.async = true;
        script.src =
            "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2721836557124559";
        script.crossOrigin = "anonymous";
        document.head.appendChild(script);
        window.adsenseLoaded = true;
    }

    // Safely push ad
    try {
        (window.adsbygoogle = window.adsbygoogle || []).push({});
    } catch (e) {
        console.warn("Adsense not ready yet", e);
    }

    const showResults = () => {
        if (document.getElementById("mtqAdOverlay")) {
            overlay.remove();
        }
        renderMTQResults(results, correctTasks, totalTasks);
        showStep(8);
    };

    // Normal close
    const normalTimer = setTimeout(showResults, 5000);

    // Hard fallback
    const maxTimer = setTimeout(() => {
        clearTimeout(normalTimer);
        showResults();
    }, 8000);
}

window.renderMTQResults = renderMTQResults;







// Attach click handlers
document.querySelectorAll('.subject-btn').forEach(btn => {
  const yearBtn = btn.closest('li')?.querySelector('.year-btn');
  if (!yearBtn) return;

  const year = yearBtn.dataset.year;
  const subject = btn.textContent.trim().toLowerCase();

  btn.addEventListener('click', () => loadPastQuestions(year, subject));
});




const titleElement = document.getElementById("goquizTitle");

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    const firstName = user.displayName?.split(" ")[0] || "User";

    titleElement.textContent = `GoQuiz ${firstName}`;
    localStorage.setItem("firstName", firstName);
    localStorage.setItem("userUid", user.uid);
  } else {
    localStorage.removeItem("userUid");
  }
});





// Menu toggling
document.getElementById('openMenuBtn').onclick = () => {
  document.getElementById('menuPanel').classList.remove('-translate-x-full');
};
  document.getElementById('closeMenuBtn').onclick = () => {
  document.getElementById('menuPanel').classList.add('-translate-x-full');
};










let allQuizzesGlobal = [];

async function loadPublicFeed() {
    const feed = document.getElementById("publicFeed");
    feed.innerHTML = "";
    allQuizzesGlobal = [];

    const authors = ["Ada", "Urum", "Ibrahim", "Nwamaka", "Fatima", "Iroha", "Amiri"];
    const times = ["3h ago", "5h ago", "1 day ago", "2 days ago", "3 days ago"];

    const categories = ['jamb', 'common_entrance', 'ACCA'];
    const years = [2020, 2021, 2022, 2023];
    const subjects = ["english", "maths", "physics", "chemistry", "biology", "economics", "literature", "F1", "F3"];

    const fetchPromises = [];

    for (const cat of categories) {
        for (const year of years) {
            for (const subject of subjects) {
                const url = `past_questions/${cat}_${year}_${subject}.json`;
                const promise = fetch(url)
                    .then(async (res) => {
                        if (!res.ok) return null;
                        const data = await res.json();
                        return { data, cat, year, subject };
                    })
                    .catch(() => null);
                fetchPromises.push(promise);
            }
        }
    }

    try {
        const results = await Promise.all(fetchPromises);

        for (const item of results) {
            if (!item || !item.data.quiz || !Array.isArray(item.data.quiz)) continue;

            const normalized = item.data.quiz.map(q => {
                let optionsArr = Array.isArray(q.options) ? q.options.slice(0, 4) :
                                q.options && typeof q.options === "object" ? ["A", "B", "C", "D"].map(k => q.options[k]).filter(v => v) :
                                ["A", "B", "C", "D"];

                let correctIndex = typeof q.correct === "string" ? letterToIndex(q.correct) :
                                  typeof q.answer === "string" ? letterToIndex(q.answer) :
                                  Number.isInteger(q.correct) ? q.correct : 0;

                return {
                    title: `[${item.cat.toUpperCase()}] ${item.subject.charAt(0).toUpperCase() + item.subject.slice(1)} (${item.year})`,
                    author: authors[Math.floor(Math.random() * authors.length)],
                    question: q.question || "Untitled question",
                    options: optionsArr,
                    correct: correctIndex,
                    time: times[Math.floor(Math.random() * times.length)]
                };
            });

            allQuizzesGlobal.push(...normalized);
        }

        allQuizzesGlobal.sort(() => Math.random() - 0.5);
        renderFeedBatch();

    } catch (err) {
        console.error("Error loading combined public feed:", err);
        feed.innerHTML = `<p class="text-center text-gray-500 py-10">Failed to load feed.</p>`;
    }
}

function closeFeedBatch() {
    const feed = document.getElementById("publicFeed");
    if (feed) {
        feed.classList.add("hidden");
        // Also reset display style to ensure hidden takes effect
        feed.style.display = "none"; 
    }
}



function renderFeedBatch() {
    const feed = document.getElementById("publicFeed");
    feed.classList.remove("hidden");
    feed.style.display = "block";
    feed.innerHTML = "";

    // Remove old Load More button
    const oldButton = document.querySelector("#loadMoreBtn");
    if (oldButton) oldButton.remove();

    if (!allQuizzesGlobal.length) {
        feed.innerHTML =
            "<p class='text-center text-gray-500 py-10'>No quizzes available yet.</p>";
        return;
    }

    const feedQuizzes = allQuizzesGlobal
        .sort(() => 0.5 - Math.random())
        .slice(0, 10);

    feedQuizzes.forEach((quiz, index) => {
        const card = document.createElement("div");
        card.className =
            "bg-white rounded-xl shadow p-5 hover:shadow-md transition border border-gray-100 mb-4 max-w-2xl mx-auto";

        card.innerHTML = `
            <p class="text-lg font-semibold">${quiz.title}</p>
            <p class="text-gray-500 text-sm mb-3">
                Posted by ${quiz.author} | ${quiz.time}
            </p>
            <p class="text-gray-700 mb-4">${quiz.question}</p>
            <div class="options flex flex-col gap-2 mb-3"></div>
        `;

        const optionsDiv = card.querySelector(".options");

        quiz.options.forEach((opt, i) => {
            const btn = document.createElement("button");
            btn.className =
                "bg-indigo-600 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-700 transition";
            btn.textContent = opt;

            btn.addEventListener("click", () => {
                if (i === quiz.correct) {
                    btn.style.backgroundColor = "green";
                    updateCoinDisplay(2);
                } else {
                    btn.style.backgroundColor = "red";
                    updateCoinDisplay(-1);
                }
                Array.from(optionsDiv.children).forEach(b => b.disabled = true);
            });

            optionsDiv.appendChild(btn);
        });

        feed.appendChild(card);

        // ‚úÖ IN-FEED AD EVERY 5 CARDS
        if ((index + 1) % 5 === 0) {
            const adWrapper = document.createElement("div");
            adWrapper.className =
                "mb-4 bg-white rounded-xl shadow p-5 border border-gray-100 max-w-2xl mx-auto";

            adWrapper.innerHTML = `
                <div class="text-xs text-gray-500 text-center mb-3 opacity-70">
                    Sponsored
                </div>
                <ins class="adsbygoogle"
                    style="display:block; min-width:250px"
                    data-ad-format="fluid"
                    data-ad-layout-key="-eb+6a-2e-5p+jd"
                    data-ad-client="ca-pub-2721836557124559"
                    data-ad-slot="8794531493">
                </ins>
            `;

            feed.appendChild(adWrapper);

            // ‚úÖ SAFE delayed push
            safeAdsensePush(400);
        }
    });

    // BIG LOAD MORE BUTTON
    const loadMoreWrapper = document.createElement("div");
    loadMoreWrapper.className = "flex justify-center my-12 pb-40";
    loadMoreWrapper.innerHTML = `
        <button id="loadMoreBtn"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-10 rounded-full shadow-2xl text-lg transition transform hover:scale-105">
            Load More Quizzes
        </button>
    `;
    feed.appendChild(loadMoreWrapper);

    document.getElementById("loadMoreBtn").onclick = () => {
        renderFeedBatch();
        window.scrollTo({ top: 0, behavior: "smooth" });
    };

    document.getElementById("app").classList.add("hidden");
    document.documentElement.style.scrollPaddingBottom = "160px";
}

// Load feed on page load
window.addEventListener("DOMContentLoaded", loadPublicFeed);

// Hide splash screen
setTimeout(() => {
    const splash = document.getElementById("splash");
    const main = document.getElementById("main-content");
    if (splash) splash.style.display = "none";
    if (main) main.style.display = "block";
}, 3500);

// Quiz step navigation
const steps = document.querySelectorAll('.step');
function showStep(n) {
    steps.forEach(s => s.classList.add('hidden'));
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('publicFeed').classList.add('hidden');
    if (steps[n - 1]) steps[n - 1].classList.remove('hidden');
    window.scrollTo({top:0, behavior:"smooth"})
}



// üé∂ Circular Music Menu Script
const menuToggle = document.getElementById("menu-toggle");
const circularMenu = document.getElementById("circular-menu");
const audioPlayer = document.getElementById("audio-player");

const playButton = document.getElementById("play-button");
const pauseButton = document.getElementById("pause-button");
const nextButton = document.getElementById("next-button");
const prevButton = document.getElementById("prev-button");

// Playlist
const tracks = [
  { name: "Relaxing Melody", src: "music/track1.mp3" },
  { name: "Focus Beat", src: "music/track2.mp3" },
  { name: "Chill Vibes", src: "music/track3.mp3" },
  { name: "Ambient Tune", src: "music/track4.mp3" },
   { name: "Relaxing Melody", src: "music/track5.mp3" },
  { name: "Focus Beat", src: "music/track6.mp3" },
  { name: "Chill Vibes", src: "music/track7.mp3" },
  { name: "Ambient Tune", src: "music/track8.mp3" },
   { name: "Relaxing Melody", src: "music/track9.mp3" },
  { name: "Focus Beat", src: "music/track10.mp3" },
  { name: "Chill Vibes", src: "music/track11.mp3" },
  { name: "Ambient Tune", src: "music/track12.mp3" },
  { name: "Chill Vibes", src: "music/track13.mp3" },
  { name: "Ambient Tune", src: "music/track14.mp3" },
];

let currentTrackIndex = Math.floor(Math.random() * tracks.length);

// Toggle open/close
menuToggle.addEventListener("click", () => {
  circularMenu.classList.toggle("open");
});

// Load and play a track
function loadTrack(index) {
  if (index < 0) index = tracks.length - 1;
  if (index >= tracks.length) index = 0;
  currentTrackIndex = index;

  const track = tracks[index];
  audioPlayer.src = track.src;
  audioPlayer.play().catch(err => console.log("‚ö†Ô∏è Autoplay blocked:", err));
}

// Controls
playButton.addEventListener("click", () => {
  if (!audioPlayer.src) loadTrack(currentTrackIndex);
  else audioPlayer.play();
});

pauseButton.addEventListener("click", () => audioPlayer.pause());

nextButton.addEventListener("click", () => {
  const nextIndex = Math.floor(Math.random() * tracks.length);
  loadTrack(nextIndex);
});

prevButton.addEventListener("click", () => {
  const prevIndex = Math.floor(Math.random() * tracks.length);
  loadTrack(prevIndex);
});

// Auto-next
audioPlayer.addEventListener("ended", () => {
  const nextIndex = Math.floor(Math.random() * tracks.length);
  loadTrack(nextIndex);
});

// Optional: Start a random track on load
window.addEventListener("DOMContentLoaded", () => {
  loadTrack(currentTrackIndex);
});



// ----------------------
// Teacher Form Overlay
// ----------------------
const openTeacherPost = document.getElementById("openTeacherPost");
const teacherFormOverlay = document.getElementById("teacherFormOverlay");
const closeTeacherPost = document.getElementById("closeTeacherPost");
const submitTeacherPost = document.getElementById("submitTeacherPost");

// Store Teacher Posts Locally
let teacherPosts = []; 

// 1. Toggle Overlay
openTeacherPost.onclick = () => teacherFormOverlay.classList.remove("hidden");
closeTeacherPost.onclick = () => {
    teacherFormOverlay.classList.add("hidden");
    resetTeacherForm();
};

// 2. Helper to reset form fields
const resetTeacherForm = () => {
    document.getElementById("teacherName").value = "";
    document.getElementById("teacherGender").value = "";
    document.getElementById("teacherSubject").value = "";
    document.getElementById("teacherPhoneNumber").value = "";
    document.getElementById("teacherImage").value = "";
};

// 3. Submit Handler
submitTeacherPost.onclick = async () => {
    // 1. Get the current logged-in user
    const user = auth.currentUser; 
    if (!user) {
        alert("You must be signed in to submit a profile.");
        return;
    }

    // Collect values from form
    const name = document.getElementById("teacherName").value.trim();
    const gender = document.getElementById("teacherGender").value;
    const subject = document.getElementById("teacherSubject").value.trim();
    const phone = document.getElementById("teacherPhoneNumber").value.trim();
    const imageFile = document.getElementById("teacherImage").files[0];

    if (!name || !gender || !subject || !phone || !imageFile) {
        alert("All fields including an image are required.");
        return;
    }

    // 2. Fetch the secure ID Token from Firebase
    const idToken = await user.getIdToken(); 

    const formData = new FormData();
    formData.append("name", name);
    formData.append("gender", gender);
    formData.append("subject", subject);
    formData.append("phone", phone);
    formData.append("image", imageFile);
    formData.append("teacherEmail", user.email);

    submitTeacherPost.disabled = true;
    submitTeacherPost.innerText = "Saving...";

    try {
        const res = await fetch("/api/teacher", {
            method: "POST",
            headers: {
                // 3. Send the token in the Authorization header
                "Authorization": `Bearer ${idToken}` 
            },
            body: formData
        });

        const data = await res.json();
        if (data.success) {
            alert("Teacher profile saved!");
            teacherFormOverlay.classList.add("hidden");
            resetTeacherForm();
        } else {
            alert("Failed: " + (data.error || "Unknown error"));
        }
    } catch (err) {
        console.error("Submission Error:", err);
    } finally {
        submitTeacherPost.disabled = false;
        submitTeacherPost.innerText = "Submit Profile";
    }
};





/* Open Requests Popup (Updated function to include filters) */
const teacherModal = document.getElementById('teacherModal');
const profileGrid = document.getElementById('profileGrid');

// Function to open the modal and fetch profiles
// --- Navigation Trigger ---
function openRequests() { // Triggered by your existing "meet our teachers +" button
    document.getElementById("teachersCatalogueModal").classList.remove("hidden");
    fetchTeachersData(); 
}

function closeTeachersModal() {
    document.getElementById("teachersCatalogueModal").classList.add("hidden");
}

// --- Data Fetching (Matching fetchCatalogueData) ---
/* --- Global State --- */
let allTeachers = []; // Global variable to store fetched data

function openRequests() {
    document.getElementById("teachersCatalogueModal").classList.remove("hidden");
    fetchTeachersData(); 
}

function closeTeachersModal() {
    document.getElementById("teachersCatalogueModal").classList.add("hidden");
}

async function fetchTeachersData() {
    const list = document.getElementById("teacherList");
    list.innerHTML = "<p class='col-span-full text-center py-10 text-gray-500 italic'>Finding available teachers...</p>";
    
    try {
        const res = await fetch("/api/teachers"); 
        const data = await res.json();
        
        if (data.success) {
            allTeachers = data.data; // Save data for filtering
            renderTeachers(allTeachers);
        } else {
            list.innerHTML = `<p class='col-span-full text-center py-10 text-red-500'>Error: ${data.error}</p>`;
        }
    } catch (err) {
        console.error("Fetch Error:", err);
        list.innerHTML = "<p class='col-span-full text-center py-10 text-red-500'>Server connection failed.</p>";
    }
}

// Filter Function
function filterTeachers() {
    const searchTerm = document.getElementById("teacherSearch").value.toLowerCase();
    const genderValue = document.getElementById("genderFilter").value;

    const filtered = allTeachers.filter(teacher => {
        const matchesSearch = teacher.name.toLowerCase().includes(searchTerm) || 
                              teacher.subject.toLowerCase().includes(searchTerm);
        const matchesGender = genderValue === "" || teacher.gender === genderValue;
        return matchesSearch && matchesGender;
    });

    renderTeachers(filtered);
}

function renderTeachers(teachers) {
    const list = document.getElementById("teacherList");
    if (!teachers || teachers.length === 0) {
        list.innerHTML = "<p class='col-span-full text-center py-10 text-gray-500'>No teachers found.</p>";
        return;
    }

    list.innerHTML = teachers.map(teacher => `
        <div class="bg-white border border-gray-200 rounded-2xl p-5 shadow-sm hover:shadow-md transition flex flex-col items-center">
            <div class="relative mb-4">
                <img src="${teacher.imageUrl || 'via.placeholder.com'}" 
                     class="w-24 h-24 rounded-full object-cover border-4 border-green-50"
                     alt="${teacher.name}">
                <div class="absolute bottom-1 right-1 w-4 h-4 bg-green-500 border-2 border-white rounded-full"></div>
            </div>
            
            <h3 class="font-bold text-gray-800 text-lg">${teacher.name}</h3>
            <p class="text-green-600 font-medium text-sm mb-3">${teacher.subject}</p>
            
            <div class="flex space-x-2 mb-4">
                <span class="text-[10px] bg-gray-100 px-2 py-1 rounded-full text-gray-500 uppercase font-bold tracking-wider">
                    ${teacher.gender}
                </span>
            </div>

                        
            <button onclick="handleAction('${teacher.id}', 'teacher')" 
                    class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-xl text-sm font-bold transition-colors">
                Contact Teacher
            </button>

        </div>
    `).join('');
}

/* --- Event Listeners for Filters --- */
document.getElementById("teacherSearch")?.addEventListener("input", filterTeachers);
document.getElementById("genderFilter")?.addEventListener("change", filterTeachers);



// Add this new function to your frontend JS file:
window.acceptRequest = async function acceptRequest(requestId) {
  if (!confirm("Are you sure you want to accept this request?")) return;

  try {
    // üîê Get Firebase ID token of the currently logged-in user
    const user = firebase.auth().currentUser;

    if (!user) {
      alert("You must be logged in as a teacher.");
      return;
    }

    const idToken = await user.getIdToken();

    const res = await fetch(`/api/acceptRequest/${requestId}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${idToken}` // ‚úÖ THIS FIXES THE 401
      }
    });

    const data = await res.json();

    if (!res.ok) {
      alert(`Failed to accept request: ${data.error}`);
      return;
    }

    alert(data.message);
    openRequests(); // refresh UI
  } catch (err) {
    console.error("Accept request error:", err);
    alert("Error accepting request.");
  }
};


function home() {
  menuPanel.classList.add('-translate-x-full');
  closePaymentModal()
  closeBooksCatalogueModal()
  renderFeedBatch();
  window.scrollTo({top:0, behavior:"smooth"})

};

function closeBooksCatalogueModal() {
  
  document.getElementById("booksCatalogueModal").classList.add("hidden")
  renderFeedBatch();
};

// --- Modal Navigation (Unified) ---
function openBooksHub() {
    document.getElementById("booksHubModal").classList.remove("hidden");
}
function closeBooksHub() {
    document.getElementById("booksHubModal").classList.add("hidden");
}

function openPostBook() {
    closeBooksHub();
    document.getElementById("postBookModal").classList.remove("hidden");
    
    // Reset container and add the first book entry automatically
    const container = document.getElementById("bookEntriesContainer");
    if (container.children.length === 0) {
        addBookEntry();
    }
}

function closePostBookModal() {
    document.getElementById("postBookModal").classList.add("hidden");
    // Clear the entries so it starts fresh next time
    document.getElementById("bookEntriesContainer").innerHTML = '';
}

// --- Dynamic Book Entries ---
function addBookEntry() {
    const container = document.getElementById("bookEntriesContainer");
    const entryId = Date.now(); 
    
    const entryHtml = `
        <div id="entry-${entryId}" class="p-4 border border-gray-200 rounded-lg bg-gray-50 relative space-y-3">
            <button type="button" onclick="removeBookEntry(${entryId})" class="absolute top-2 right-2 text-red-500 font-bold text-sm">‚úï Remove</button>
            
            <input type="text" name="title" placeholder="Book Title" class="w-full border border-gray-300 rounded-lg p-2" required>
            <div class="grid grid-cols-2 gap-2">
                <input type="text" name="author" placeholder="Author" class="w-full border border-gray-300 rounded-lg p-2" required>
                <input type="number" name="price" placeholder="Price (‚Ç¶)" class="w-full border border-gray-300 rounded-lg p-2" required>
            </div>
            <select name="condition" class="w-full border border-gray-300 rounded-lg p-2">
                <option value="">Select condition</option>
                <option value="like-new">Like New</option>
                <option value="good">Good</option>
                <option value="fair">Fair</option>
            </select>
            <!-- Name MUST be "images" to match upload.array("images") in backend -->
            <input type="file" name="images" accept="image/*" class="w-full border border-gray-300 rounded-lg p-2">
        </div>
    `;
    container.insertAdjacentHTML('beforeend', entryHtml);
}


function removeBookEntry(id) {
    const entry = document.getElementById(`entry-${id}`);
    if (document.querySelectorAll('#bookEntriesContainer > div').length > 1) {
        entry.remove();
    } else {
        alert("You must post at least one book before removing.");
    }
}

function openRequestBook() {
    closeBooksHub();
    document.getElementById("requestBookModal").classList.remove("hidden");
}
function closeRequestBookModal() {
    document.getElementById("requestBookModal").classList.add("hidden");
}

// --- SELL A BOOK HANDLER (Matches Teacher Style) ---
document.getElementById("postBookForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const user = firebase.auth().currentUser;
    if (!user) return alert("Please log in first.");

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const formData = new FormData(e.target);
    const titles = formData.getAll("title"); 
    
    if (titles.length === 0 || !titles[0].trim()) {
        alert("Please add at least one book with a title.");
        return;
    }

    // --- START LOADING STATE ---
    submitBtn.disabled = true;
    submitBtn.innerHTML = `<span class="animate-pulse">Uploading ${titles.length} Book(s)...</span>`;

    try {
        const token = await user.getIdToken();
        
        const res = await fetch("/api/postBook", {
            method: "POST",
            headers: { 
                "Authorization": `Bearer ${token}` 
                // Reminder: Browser sets multipart/form-data boundary automatically
            },
            body: formData
        });

        const data = await res.json();
        if (data.success) {
            alert(`‚úÖ ${data.count || 'Books'} listed for sale!`);
            e.target.reset();
            document.getElementById("bookEntriesContainer").innerHTML = '';
            closePostBookModal();
            if(window.loadBooks) loadBooks(); 
        } else {
            alert("Failed to list books: " + data.error);
        }
    } catch (err) {
        console.error("Submission error:", err);
        alert("Server error. Please check your connection.");
    } finally {
        // --- END LOADING STATE ---
        submitBtn.disabled = false;
        submitBtn.innerText = "Post Book(s)";
    }
});


// --- I NEED A BOOK HANDLER (Matches Teacher Style) ---
document.getElementById("requestBookForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const user = firebase.auth().currentUser;
    if (!user) return alert("Please log in first.");

    const title = e.target.title.value.trim();
    const author = e.target.author.value.trim();
    const notes = e.target.notes.value.trim();
    const location = e.target.location.value.trim();
    const phoneNumber = e.target.phoneNumber.value.trim();

    if (!title) return alert("Book Title is required.");

    try {
        const token = await user.getIdToken();
        const res = await fetch("/api/requestBook", {
            method: "POST",
            headers: { 
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json" 
            },
            body: JSON.stringify({ title, author, notes, location,phoneNumber })
        });

        const data = await res.json();
        if (data.success) {
            alert("‚úÖ Request submitted to catalogue!");
            e.target.reset();
            closeRequestBookModal();
        } else {
            alert("Failed to submit request.");
        }
    } catch (err) {
        console.error(err);
    }
});


// --- Global Data Store ---
let currentCatalogueData = []; 
let currentView = 'sale'; // 'sale' or 'request'

// --- Navigation Trigger ---
function openBooks() {
    if (typeof closeBooksHub === "function") closeBooksHub(); 
    document.getElementById("booksCatalogueModal").classList.remove("hidden");
    fetchCatalogueData(); 
}

// --- Data Fetching (Adapted to separate endpoints) ---
async function fetchCatalogueData() {
    const list = document.getElementById("catalogueList");
    list.innerHTML = "<p class='col-span-2 text-center py-10 text-gray-500 italic'>Loading catalogue...</p>";
    
    const endpoint = currentView === 'sale' ? "/api/getAvailableBooks" : "/api/getBookRequests";
    
    try {
        const res = await fetch(endpoint);
        const data = await res.json();
        
        if (data.success) {
            currentCatalogueData = currentView === 'sale' ? data.books : data.requests;
            renderCatalogue();
        } else if (data.error && data.error.includes("index")) {
            // Specifically catching the index error
            list.innerHTML = `<p class='col-span-2 text-center py-10 text-amber-600'>
                <b>Database Index Building...</b><br>
                Please wait 2-5 minutes for Firebase to prepare the data.
            </p>`;
        } else {
            list.innerHTML = `<p class='col-span-2 text-center py-10 text-red-500'>Error: ${data.error}</p>`;
        }
    } catch (err) {
        console.error("Fetch Error:", err);
        list.innerHTML = "<p class='col-span-2 text-center py-10 text-red-500'>Server connection failed.</p>";
    }
}

// --- Toggle View Switcher ---
function toggleCatalogueView(view) {
    currentView = view;
    // Update button styling
    document.getElementById("btnShowSale").className = view === 'sale' 
        ? "px-4 py-1 rounded-full bg-purple-600 text-white text-sm" 
        : "px-4 py-1 rounded-full bg-gray-200 text-gray-700 text-sm";
    
    document.getElementById("btnShowRequests").className = view === 'request' 
        ? "px-4 py-1 rounded-full bg-purple-600 text-white text-sm" 
        : "px-4 py-1 rounded-full bg-gray-200 text-gray-700 text-sm";
    
    fetchCatalogueData(); // Re-fetch for the new category
}

// --- Rendering Logic ---
function renderCatalogue() {
    const list = document.getElementById("catalogueList");
    const query = document.getElementById("catalogueSearch").value.toLowerCase();
    
    list.innerHTML = "";
    
    const filtered = currentCatalogueData.filter(item => 
        item.title.toLowerCase().includes(query) || 
        (item.author && item.author.toLowerCase().includes(query)) ||
        (item.location && item.location.toLowerCase().includes(query)) // Now searchable by city too!
    );

    if (filtered.length === 0) {
        list.innerHTML = `<p class="col-span-2 text-center text-gray-400 py-10">No ${currentView === 'sale' ? 'books for sale' : 'requests'} found.</p>`;
        return;
    }

    filtered.forEach(item => {
        const card = document.createElement("div");
        card.className = "border border-gray-200 rounded-lg p-3 shadow-sm bg-white hover:shadow-md transition-all";
        card.innerHTML = `
            ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-full h-40 object-cover rounded-lg mb-2">` : ""}
            <h4 class="font-bold text-gray-800">${item.title}</h4>
            <p class="text-xs text-gray-500 italic">by ${item.author || 'Unknown'}</p>
            
            <!-- LOCATION DISPLAY ADDED HERE -->
            <div class="flex items-center text-xs text-gray-600 mt-1 bg-gray-100 w-fit px-2 py-0.5 rounded">
                <span class="material-icons" style="font-size: 14px; margin-right: 4px;">place</span>
                ${item.location || 'Unknown City'}
            </div>

            <p class="text-sm mt-2 text-purple-600 font-semibold">${item.price ? `‚Ç¶${item.price}` : "Status: Pending Request"}</p>
            
            <button onclick="handleAction('${item.id}', '${item.type}')" 
                    class="w-full mt-2 py-2 text-xs font-bold rounded border border-purple-500 text-purple-600 hover:bg-purple-600 hover:text-white transition">
                ${item.type === 'sale' ? 'Interested' : 'I have this book'}
            </button>
        `;
        list.appendChild(card);
    });
}


 // Step 1: Open the Payment Information Modal
// Ensure this variable is declared globally in your frontend script
let pendingAction = null;

function openTopupWalletModal() {
  document.getElementById("topupModal").classList.remove("hidden");
  document.getElementById("topupModal").classList.add("flex");
}

function closeTopupModal() {
  document.getElementById("topupModal").classList.add("hidden");
  document.getElementById("topupModal").classList.remove("flex");
}

function selectTopup(coins) {
  // 1. Assign selected coins to global variable as per your existing logic
  selectedTopupCoins = coins;

  // 2. Pricing in kobo (Subunit of NGN)
  const prices = {
    100: 1000 * 100, // ‚Ç¶1,000 -> 100,000 kobo
    250: 2000 * 100, // ‚Ç¶2,000 -> 200,000 kobo
    500: 3000 * 100, // ‚Ç¶3,000 -> 300,000 kobo
  };

  const user = firebase.auth().currentUser;
  if (!user) return alert("Login required");

  // 3. Initiate Transaction using V2 syntax
  user.getIdToken().then(token => {
    const paystack = new PaystackPop();
    
    paystack.newTransaction({
      key: "pk_live_055df5963ca6c17db25a027d90a5bc1963b52f67", // Public key
      email: user.email,
      amount: prices[coins],
      currency: "NGN",
      
      // onSuccess replaces the old callback property
      onSuccess: (transaction) => {
        // V2 returns the reference inside the transaction object
        completeTopup(transaction.reference, coins);
      },
      
      // onCancel replaces the old onClose property
      onCancel: () => {
        alert("Top up cancelled");
      }
    });
    // Note: newTransaction() automatically opens the popup; openIframe() is no longer needed.
  });
}


async function completeTopup(reference) {
  const user = firebase.auth().currentUser;
  const token = await user.getIdToken();

  const res = await fetch("/api/wallet/topup", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify({
      reference,
      coins: selectedTopupCoins
    })
  });

  const data = await res.json();

  if (!data.success) {
    alert("Top up failed");
    return;
  }

  updateUI(data.newBalance);
  closeTopupModal();

  alert("üéâ Wallet topped up successfully!");
}


async function handleAction(id, type) {
    const user = firebase.auth().currentUser;
    if (!user) return alert("Please log in to respond to posts.");

    pendingAction = { id, type };

    const cost = 5;
    // Force to Number to ensure comparison works 100% of the time
    const currentCoins = Number(userPoints) || 0; 

    if (currentCoins < cost) {
        // Logic: Alert blocks execution until "OK" is clicked
        alert(`You have insufficient Gocoins. You need ${cost} Gocoins for this action.`);
        
        // This opens the modal from your HTML ID
        openTopupWalletModal(); 
        return;
    }

    // If user has enough coins, ask for confirmation
    if (confirm(`This action will cost ${cost} Gocoins. Do you want to proceed?`)) {
        await completeTransactionWithWalletDeduction();
    }
}


// Add this to your main <script> tag, NOT nested inside another function
function updateUI(newBalance = null, newGQ = null) {
    const coinEl = document.getElementById("walletCoinNumber");
    const gqEl = document.getElementById("GqCount");

    if (newBalance !== null) {
        userPoints = newBalance; // Update local state
        if (coinEl) coinEl.textContent = newBalance;
    }
    
    if (newGQ !== null) {
        userGQ = newGQ; // Update local state
        if (gqEl) gqEl.textContent = newGQ;
    }

    // 2026 UX: Feedback pulse
    coinEl?.classList.add("text-green-500", "scale-110");
    setTimeout(() => coinEl?.classList.remove("text-green-500", "scale-110"), 400);
}

// Global Alias (Fixes ReferenceError across all handlers)
window.updateUI = updateUI;


// --- NEW: Function to handle deduction (replaces the Paystack flow here) ---
async function completeTransactionWithWalletDeduction() {
    const { id, type } = pendingAction;
    const user = firebase.auth().currentUser;
    if (!user) return alert("Session expired. Please log in again.");

    let endpoint;
    if (type === 'sale') {
        endpoint = `/api/acceptBookWithWallet/${id}`;
    } else if (type === 'request' || type === 'book-request') {
        endpoint = `/api/fulfillRequestWithWallet/${id}`;
    } else if (type === 'teacher' || type === 'teacher-request') {
        endpoint = `/api/acceptRequestWithWallet/${id}`;
    } else {
        alert("Unknown action type.");
        return;
    }

    const phoneInput = document.getElementById("accepterPhone");
    const accepterPhone = phoneInput ? phoneInput.value.trim() : "N/A";

    try {
        const token = await user.getIdToken();

        const res = await fetch(endpoint, {
            method: "POST",
            headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ accepterPhone })
        });

        const data = await res.json();

        if (data.success) {
            alert("‚úÖ Success! Check your email for contact details.");

            if (data.newBalance !== undefined) {
                userPoints = data.newBalance;
                updateUI();
            }

            if (typeof closePaymentModal === "function") closePaymentModal();
            if (typeof fetchCatalogueData === "function") fetchCatalogueData();
            if (typeof fetchTeachersData === "function") fetchTeachersData();

            pendingAction = null;

        } else {
            // üî• THIS IS THE IMPORTANT PART
            if (data.error?.toLowerCase().includes("insufficient")) {
                openTopupWalletModal();
                return;
            }

            alert("Action failed: " + data.error);
        }

    } catch (err) {
        console.error("Wallet Action Error:", err);
        alert("An error occurred. Please try again.");
    }
}

// Ensure the updated function is globally accessible
window.completeTransactionWithWalletDeduction = completeTransactionWithWalletDeduction;

// Step 2: Redirect to Paystack (v2 implementation)
async function proceedToPayment() {
    const user = firebase.auth().currentUser;
    const phoneElement = document.getElementById("accepterPhone");
    
    if (!phoneElement || !phoneElement.value.trim()) {
        return alert("Please enter your phone number first.");
    }

    const accepterPhone = phoneElement.value.trim();

    try {
        const paystack = new PaystackPop();
        paystack.newTransaction({
            key: "pk_live_055df5963ca6c17db25a027d90a5bc1963b52f67", 
            email: user.email,
            amount: 10000, // ‚Ç¶100.00
            currency: "NGN",
            // v2 uses 'onSuccess' inside the main object or via .resume()
            onSuccess: (transaction) => {
                console.log("Payment Successful. Reference:", transaction.reference);
                completeTransaction(transaction.reference, accepterPhone);
            },
            onCancel: () => {
                alert('Transaction was cancelled.');
            },
            // Metadata helps you track the phone number in the Paystack dashboard
            metadata: {
                custom_fields: [
                    {
                        display_name: "Customer Phone",
                        variable_name: "customer_phone",
                        value: accepterPhone
                    }
                ]
            }
        });
    } catch (error) {
        console.error("Initialization Error:", error);
    }
}

// UI Helper: Close and Reset
function closePaymentModal() {
    const modal = document.getElementById("paymentModal");
    if (modal) modal.classList.add("hidden");
    
    // Ensure this ID matches your HTML input ID
    const phoneInput = document.getElementById("accepterPhone");
    if (phoneInput) phoneInput.value = "";
}

// Step 3: Fulfill record (Server-side verification)
async function completeTransaction(paymentReference, accepterPhone) {
    // 1. UI Cleanup
    closePaymentModal(); 

    const { id, type } = pendingAction; // type can now be 'sale', 'book-request', or 'teacher-request'
    const user = firebase.auth().currentUser;

    try {
        const token = await user.getIdToken();
        
        // 2. Determine the correct endpoint based on action type
        let endpoint;
        if (type === 'sale') {
            endpoint = `/api/acceptBook/${id}`;
        } else if (type === 'book-request') {
            endpoint = `/api/fulfillRequest/${id}`;
        } else if (type === 'teacher-request') {
            // Updated to match your new teacher route
            endpoint = `/api/fulfillTeacherRequest/${id}`; 
        }

        const res = await fetch(endpoint, {
            method: "POST",
            headers: { 
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ 
                reference: paymentReference,
                accepterPhone: accepterPhone 
            })
        });

        const data = await res.json();

        if (data.success) {
            alert("‚úÖ Success! Connection made. Check your email for details.");
            
            // Refresh UI data
            if (typeof fetchCatalogueData === "function") fetchCatalogueData();
            if (typeof fetchTeacherRequests === "function") fetchTeacherRequests();
            
        } else {
            // 404 Troubleshooting: If you get a 404 here, ensure 'endpoint' matches your backend route exactly
            document.getElementById("paymentModal").classList.remove("hidden");
            alert("Record update failed: " + data.error);
        }
    } catch (err) {
        console.error("Finalization Error:", err);
        alert("An error occurred while saving your transaction.");
    }
}


function openCreateRequest() {
    // This should point to your "I need a book" or "Teacher Request" modal
    const modal = document.getElementById("requestBookModal"); 
    if (modal) {
        modal.classList.remove("hidden");
    } else {
        console.warn("Modal 'requestBookModal' not found.");
    }
}


let userPoints = 0; // global wallet balance

async function fetchUserWallet() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  try {
    const token = await user.getIdToken();

    const res = await fetch("/api/wallet", {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });

    const data = await res.json();

    if (data.success) {
      userPoints = data.coinBalance;
      updateUI(userPoints);
    } else {
      console.warn("Wallet fetch failed:", data.error);
    }

  } catch (err) {
    console.error("Wallet UI Sync Error:", err);
  }
}

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    fetchUserWallet();
  }
});




let selectedTopupCoins = 0;



let adFreeUntil = 0; // Global: expiry in milliseconds


// SINGLE auth listener ‚Äî add this ONCE at the top of your script
firebase.auth().onAuthStateChanged(async (user) => {
  if (user) {
    await fetchUserWallet();        // Your existing wallet fetch
    await checkAdFreeStatus();      // Fetch latest ad-free expiry from Firestore
  } else {
    // Logged out: reset
    userPoints = 0;
    adFreeUntil = 0;
    updateUI(0);
    updateAdFreeButton();
    controlAdDisplay();
  }
});

async function checkAdFreeStatus(user) {
    if (!user) {
        // User not logged in ‚Üí show ads
        document.body.classList.remove("ad-free");
        return false;
    }

    if (typeof firestore === "undefined") {
        console.warn("Firestore not initialized");
        return false;
    }

    try {
        const doc = await firestore
            .collection("adFreeUsers")
            .doc(user.uid)
            .get();

        const isAdFree = doc.exists && doc.data()?.adFree === true;

        document.body.classList.toggle("ad-free", isAdFree);
        return isAdFree;
    } catch (err) {
        console.warn("Ad-free check failed", err);
        return false;
    }
}

/**
 * Updates the Ad-Free purchase button and status text based on expiry.
 * Updated for January 2026 standards.
 */
function updateAdFreeButton() {
  const btn = document.getElementById("removeAdsBtn");
  const status = document.getElementById("adFreeStatus");

  if (!btn || !status) return;

  const now = Date.now();

  if (adFreeUntil > now) {
    // 1. Calculate precise days remaining
    const diffMs = adFreeUntil - now;
    const daysLeft = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

    // 2. Update Button UI (Still allow clicking to "Extend" if you removed the listener block)
    // If you want to disable it entirely while active, keep btn.disabled = true
    btn.textContent = `Ad-Free `;
    btn.disabled = false; // Enabled so users can "Stack/Extend" their time
    btn.classList.remove("bg-purple-600", "hover:bg-purple-700");
    btn.classList.add("bg-green-600", "hover:bg-green-700");

    // 3. Format Date for 2026 (e.g., "January 7, 2026")
    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
    const expiryDateString = new Date(adFreeUntil).toLocaleDateString(undefined, dateOptions);

    status.textContent = `‚úÖ Till ${expiryDateString}`;
    status.classList.remove("hidden");
  } else {
    // 4. Default State (Not active or expired)
    btn.textContent = "üåü Go Ad-Free for 30 Days (100 Coins)";
    btn.disabled = false;
    btn.classList.add("bg-purple-600", "hover:bg-purple-700");
    btn.classList.remove("bg-green-600", "bg-green-700", "cursor-not-allowed");
    
    status.classList.add("hidden");
    status.textContent = "";
  }
}

  function safeAdsensePush(retries = 8) {
    // 1Ô∏è‚É£ AdSense must exist
    if (
        typeof window.adsbygoogle === "undefined" ||
        typeof window.adsbygoogle.push !== "function"
    ) {
        return;
    }

    // 2Ô∏è‚É£ Find the next unprocessed ad
    const ad = document.querySelector(
        'ins.adsbygoogle:not([data-goquiz-loaded])'
    );
    if (!ad) return;

    // 3Ô∏è‚É£ Ensure ad is actually visible in layout
    const rect = ad.getBoundingClientRect();
    const width = rect.width;

    if (width < 250) {
        if (retries > 0) {
            requestAnimationFrame(() => safeAdsensePush(retries - 1));
        }
        return;
    }

    // 4Ô∏è‚É£ Lock BEFORE pushing (prevents duplicates)
    ad.dataset.goquizLoaded = "true";

    // 5Ô∏è‚É£ Safe push
    try {
        window.adsbygoogle.push({});
    } catch (e) {
        console.warn("AdSense push failed", e);
    }
}


function controlAdDisplay() {
  if (adFreeUntil > Date.now()) {
    document.body.classList.add("is-ad-free");
    (window.adsbygoogle = window.adsbygoogle || []).pauseAdRequests = 1;
  } else {
    document.body.classList.remove("is-ad-free");
    (window.adsbygoogle = window.adsbygoogle || []).pauseAdRequests = 0;
  }
}


// Purchase button (unchanged, but now stacks)
document.getElementById("removeAdsBtn")?.addEventListener("click", async () => {
  

  // 2. Check points before starting the process
  if (userPoints < 100) {
    alert("You need 100 coins for 30 days ad-free!");
    if (typeof openTopupWalletModal === "function") openTopupWalletModal();
    return;
  }

  // 3. Dynamic confirmation message
  const isCurrentlyAdFree = adFreeUntil > Date.now();
  const msg = isCurrentlyAdFree 
    ? "You are already ad-free. Would you like to add 30 MORE days to your current expiry for 100 coins?" 
    : "Activate 30 days of ad-free browsing for 100 coins?";

  if (!confirm(msg)) return;

  const user = firebase.auth().currentUser;
  if (!user) return alert("Please log in.");

  try {
    // Show a loading state (optional but recommended)
    const btn = document.getElementById("removeAdsBtn");
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "Processing...";

    const token = await user.getIdToken();
    const res = await fetch("/api/activateAdFree", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}` 
      }
    });
    const data = await res.json();

    if (data.success) {
      // Update global variables with fresh data from the server
      userPoints = data.newBalance;
      adFreeUntil = data.adFreeUntil; 

      // Refresh the UI
      updateUI(userPoints);
      updateAdFreeButton();
      controlAdDisplay();
      
      alert(`Success! Ad-free extended until ${new Date(data.adFreeUntil).toLocaleDateString()}`);
    } else {
      alert("Failed: " + data.error);
      // Re-enable button if failed
      btn.disabled = false;
      btn.textContent = originalText;
    }
  } catch (err) {
    alert("Error connecting to server: " + err.message);
  }
});



window.openTopupWalletModal = openTopupWalletModal;
window.openCreateRequest = openCreateRequest; 
window.handleAction = handleAction;
window.proceedToPayment = proceedToPayment;
window.closePaymentModal = closePaymentModal;


</script>
</body>
</html>